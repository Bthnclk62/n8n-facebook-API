{
  "name": "Hotel Agent - Automation v20 (ULTIMATE FIX)",
  "nodes": [
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyX",
              "value": 30,
              "unit": "minutes"
            }
          ]
        },
        "documentId": {
          "__rl": true,
          "value": "1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek",
          "mode": "list",
          "cachedResultName": "Meta Ads Automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 222526350,
          "mode": "list",
          "cachedResultName": "Son",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek/edit#gid=222526350"
        },
        "options": {
          "columnsToWatch": [],
          "dataLocationOnSheet": {
            "values": {
              "rangeDefinition": "specifyRangeA1",
              "range": "A2:AZ20000"
            }
          }
        }
      },
      "type": "n8n-nodes-base.googleSheetsTrigger",
      "typeVersion": 1,
      "position": [
        10400,
        6240
      ],
      "id": "387518f1-6bef-4eb3-976a-980bf4feebd0",
      "name": "Meta Ads Automation",
      "alwaysOutputData": true,
      "executeOnce": false,
      "retryOnFail": true,
      "waitBetweenTries": 3000,
      "credentials": {
        "googleSheetsTriggerOAuth2Api": {
          "id": "yPZoDrZzqQRGQye9",
          "name": "GoogleAuth"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "2cf5f46a-1b92-4232-a11b-9c7602d6f193",
              "name": "objective",
              "value": "={{ $('Meta Ads Automation').item.json.Objective }}",
              "type": "string"
            },
            {
              "id": "5f579912-646d-41f4-a169-a15b0e74cd9f",
              "name": "buying_type",
              "value": "={{ $('Meta Ads Automation').item.json['Buying Type'] }}",
              "type": "string"
            },
            {
              "id": "aa7c70ba-798e-4efd-8b68-70b752996a6b",
              "name": "campaign_name",
              "value": "={{ $('Meta Ads Automation').item.json['Campaign Name'] }}",
              "type": "string"
            },
            {
              "id": "197d3a97-b781-4cd7-8839-09b0ddebe23b",
              "name": "status",
              "value": "={{ $('Meta Ads Automation').item.json['Status (Campaign)'] }}",
              "type": "string"
            },
            {
              "id": "767eaca5-2db9-42d5-87d5-7d0904ed08e4",
              "name": "bid_strategy",
              "value": "={{ $('Meta Ads Automation').item.json['Bid Strategy'] }}",
              "type": "string"
            },
            {
              "id": "0d889196-3ed5-4650-bbff-aa993f5e40a3",
              "name": "special_ad_categories",
              "value": "={{ $json[\"Special Ad Categories\"] === 'NONE' ? [] : [$json[\"Special Ad Categories\"]] }}",
              "type": "string"
            },
            {
              "id": "de90998c-8a0a-42e9-a7c5-19c33e7fa9ce",
              "name": "daily_budget",
              "value": "={{ $('Meta Ads Automation').item.json['Ad Set Budget'] }}",
              "type": "string"
            },
            {
              "id": "30830bb8-f2b0-4213-8756-c184abfb6326",
              "name": "lifetime_budget",
              "value": "={{ $('Meta Ads Automation').item.json['Lifetime Budget'] }}",
              "type": "string"
            },
            {
              "id": "b3bcfc10-1cd3-4c85-bfe4-91ead7078362",
              "name": "optimization_goal",
              "value": "={{ $('Meta Ads Automation').item.json['Optimization Goal'] }}",
              "type": "string"
            },
            {
              "id": "f1cd6caf-269a-4677-a8b1-56e698bcce02",
              "name": "billing_event",
              "value": "={{ $('Meta Ads Automation').item.json['Billing Event'] }}",
              "type": "string"
            },
            {
              "id": "84d6b3cd-a63a-44db-a963-b75d845f9d03",
              "name": "ad_name",
              "value": "={{ $('Meta Ads Automation').item.json['Ad Name'] }}",
              "type": "string"
            },
            {
              "id": "9a4b0899-13f0-49aa-b48c-80673411fa7b",
              "name": "adset_name",
              "value": "={{ $('Meta Ads Automation').item.json['Ad Set Name'] }}",
              "type": "string"
            },
            {
              "id": "260ddaff-0fc8-488d-83ac-ca84a210f5e4",
              "name": "object_story_spec.link_data.message",
              "value": "={{ $('Meta Ads Automation').item.json['Primary Text'] }}",
              "type": "string"
            },
            {
              "id": "0758c889-8f56-4c01-8971-5a4256b7cc3c",
              "name": "object_story_spec.link_data.name",
              "value": "={{ $('Meta Ads Automation').item.json.Headline }}",
              "type": "string"
            },
            {
              "id": "b433f2df-0b8e-4af6-aa62-d2a2f8ed34bb",
              "name": "object_story_spec.link_data.description",
              "value": "={{ $('Meta Ads Automation').item.json.Description }}",
              "type": "string"
            },
            {
              "id": "98046b5e-bb3a-4124-a96f-ac80eaf7060e",
              "name": "object_story_spec.link_data.link",
              "value": "={{ $('Meta Ads Automation').item.json.URL }}",
              "type": "string"
            },
            {
              "id": "e44bca69-d42c-4cec-903f-b83860e51ed9",
              "name": "object_story_spec.link_data.call_to_action.type",
              "value": "={{ $('Meta Ads Automation').item.json['Call To Action'] }}",
              "type": "string"
            },
            {
              "id": "8b27599c-a7c3-4d33-841f-298e25849835",
              "name": "object_story_spec.link_data.call_to_action.value.link",
              "value": "== \"tel:+\" +{{ $('Meta Ads Automation').item.json['Call Number'] }}",
              "type": "string"
            },
            {
              "id": "428a1802-4a59-40b1-9e87-837786770447",
              "name": "status_ad",
              "value": "={{ $('Meta Ads Automation').item.json['Status (Ad)'] }}",
              "type": "string"
            },
            {
              "id": "a10e91ff-d19b-45af-a2e2-c6ad7554c5af",
              "name": "budget_type",
              "value": "={{ $('Meta Ads Automation').item.json.Budget }}",
              "type": "string"
            },
            {
              "id": "6433288a-de66-41ae-a96f-d67b1b9d11df",
              "name": "start_time",
              "value": "={{ $('Date & Time / start_time').item.json.start_time }}",
              "type": "string"
            },
            {
              "id": "547865be-6969-449d-b874-2c615875bb37",
              "name": "end_time",
              "value": "={{ $json.end_time }}",
              "type": "string"
            },
            {
              "id": "aa9db224-a54d-43f1-a020-3a9fea7754ad",
              "name": "campaign_id",
              "value": "={{ $('Meta Ads Automation').item.json['Campaign ID'] }}",
              "type": "string"
            },
            {
              "id": "e79ba141-668c-4135-b289-d930d346e243",
              "name": "adset_id",
              "value": "={{ $('Meta Ads Automation').item.json['Ad Set ID'] }}",
              "type": "string"
            },
            {
              "id": "83e6f1e6-aef6-434b-9e3b-608b546f9acd",
              "name": "ad_id",
              "value": "={{ $('Meta Ads Automation').item.json['AD ID'] }}",
              "type": "string"
            },
            {
              "id": "ad7652d5-774d-4a39-9fc6-3a94b27fc814",
              "name": "conversion_location",
              "value": "={{ $('Meta Ads Automation').item.json['Conversion Location'] }}",
              "type": "string"
            },
            {
              "id": "ab17d76b-c4d6-4095-a274-5eb517053be8",
              "name": "account_id",
              "value": "={{ $('Meta Ads Automation').item.json['Account ID'] }}",
              "type": "string"
            },
            {
              "id": "db581a1c-33a3-41f0-a8e9-b112409e789a",
              "name": "placement",
              "value": "={{ $('Meta Ads Automation').item.json.Placements }}",
              "type": "string"
            },
            {
              "id": "df71b2e7-f1bd-40a3-8cba-7b71435b1a0f",
              "name": "status_adset",
              "value": "={{ $('Meta Ads Automation').item.json['Status (Ad Set)'] }}",
              "type": "string"
            },
            {
              "id": "a6697e52-181a-433f-b450-6bd8bd75569b",
              "name": "action",
              "value": "={{ $('Meta Ads Automation').item.json.Action }}",
              "type": "string"
            },
            {
              "id": "9baebffa-5acf-4eea-ae57-ad7b0dccb78f",
              "name": "age_min",
              "value": "={{ $('Meta Ads Automation').item.json.Age_Min }}",
              "type": "string"
            },
            {
              "id": "3a4e49af-4822-4ab4-b8d3-94fd36559831",
              "name": "age_max",
              "value": "={{ $('Meta Ads Automation').item.json.Age_Max }}",
              "type": "string"
            },
            {
              "id": "ea7f950b-313e-4c70-ab77-6532ed087cf7",
              "name": "platform",
              "value": "={{ $('Meta Ads Automation').item.json.Platform }}",
              "type": "string"
            },
            {
              "id": "619416ea-1b4c-4658-a690-dac02a1bd571",
              "name": "sync",
              "value": "={{ $('Meta Ads Automation').item.json.Sync }}",
              "type": "string"
            },
            {
              "id": "d1304b0c-7bf2-46c2-aca0-be4697aad150",
              "name": "processed",
              "value": "={{ $('Meta Ads Automation').item.json.Processed }}",
              "type": "string"
            },
            {
              "id": "4e02f407-17f2-4af6-accb-df9652f94d33",
              "name": "last_error",
              "value": "={{ $('Meta Ads Automation').item.json['Last Error'] }}",
              "type": "string"
            },
            {
              "id": "cf5624be-dd24-4261-a0f0-18fdb542725d",
              "name": "updated_at",
              "value": "={{ $('Meta Ads Automation').item.json['Updated At'] }}",
              "type": "string"
            },
            {
              "id": "d788f215-c8f6-4ab0-9689-bf076e37b830",
              "name": "instagram_user_id",
              "value": "={{ $('Meta Ads Automation').item.json['IG User_ID'] }}",
              "type": "string"
            },
            {
              "id": "adb13f01-3e97-4caf-b794-0e9433beebae",
              "name": "pixel_id",
              "value": "={{ $('Meta Ads Automation').item.json.Pixel_ID }}",
              "type": "string"
            },
            {
              "id": "141a58dc-c48b-4834-afdf-8e704f05dd06",
              "name": "fb_page_id",
              "value": "={{ $('Meta Ads Automation').item.json['FB Page_ID'] }}",
              "type": "string"
            },
            {
              "id": "a440c675-2b69-4da3-80b7-557f3e18f3d9",
              "name": "row no",
              "value": "={{ $('Meta Ads Automation').item.json['Row No'] }}",
              "type": "string"
            },
            {
              "id": "a55340b3-1d96-4385-8794-6bf408bfefc5",
              "name": "end_date",
              "value": "={{ $('Meta Ads Automation').item.json['End Date'] }}",
              "type": "number"
            },
            {
              "id": "ebf19733-02e4-4a9c-863c-94b340df55bd",
              "name": "age_min",
              "value": "={{ $('Meta Ads Automation').item.json.Age_Min }}",
              "type": "number"
            },
            {
              "id": "b5b28140-8d2d-4b94-85d2-f4412270b2d8",
              "name": "age_max",
              "value": "={{ $('Meta Ads Automation').item.json.Age_Max }}",
              "type": "number"
            },
            {
              "id": "4c1d85ad-71b5-471d-91c1-de1396c44923",
              "name": "bid_amount",
              "value": "={{ $('Meta Ads Automation').item.json['Bid Amount'] }}",
              "type": "string"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        11232,
        6240
      ],
      "id": "a05e14d7-c84c-4605-8e2b-380f7d04bca4",
      "name": "Mapping"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f62da611-6aa8-4a8f-b42a-1560a86cfb22",
              "leftValue": "={{ $json.budget_type }}",
              "rightValue": "Campaign Budget",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        12320,
        6224
      ],
      "id": "1be1a9e4-2d36-4d2e-88b7-a7591a5a5eb2",
      "name": "If Budget Level (Camp Budget)"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9754a969-3afe-4c93-8ea3-a0f7dec950e8",
              "name": "campaign_id",
              "value": "={{ $json.id }}",
              "type": "string"
            },
            {
              "id": "eb876702-673a-470c-a922-7d3905031044",
              "name": "",
              "value": "",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        12912,
        6096
      ],
      "id": "0a58f81b-e8b3-46c9-a4c0-ba86f645f3ab",
      "name": "Camp. ID"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9754a969-3afe-4c93-8ea3-a0f7dec950e8",
              "name": "campaign_id",
              "value": "={{ $json.id }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        12912,
        6480
      ],
      "id": "9aa65a28-bb69-45d0-99b2-24de5d499cb2",
      "name": "Camp. ID1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v23.0/act_{{ $json.account_id || $('Mapping').item.json.account_id }}/adsets",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json._finalBody}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        13568,
        6096
      ],
      "id": "12ed9f2f-df12-4077-a968-451572d18858",
      "name": "Campaign Budget - Ad Set Create",
      "credentials": {
        "httpHeaderAuth": {
          "id": "CJvY0TtXNRCZ9OMj",
          "name": "Yango ADS"
        },
        "httpBearerAuth": {
          "id": "sOyy3sRQl00RoMfF",
          "name": "FB Token"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v23.0/act_{{ $json.account_id || $('Mapping').item.json.account_id }}/adsets",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json._finalBody }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        13536,
        6480
      ],
      "id": "f33d7617-63ee-43f5-a662-baf598a403f5",
      "name": "AD Set Budget - Ad Set Create",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "operation": "formatDate",
        "date": "={{ Number($('Meta Ads Automation').first().json['Start Date']) \n    ? new Date(Date.UTC(1899, 11, 30) + Number($('Meta Ads Automation').first().json['Start Date']) * 86400000).toISOString() \n    : '' }}",
        "format": "custom",
        "customFormat": "yyyy-MM-dd'T'HH:mm:ss'Z'",
        "outputFieldName": "start_time",
        "options": {}
      },
      "type": "n8n-nodes-base.dateTime",
      "typeVersion": 2,
      "position": [
        10816,
        6240
      ],
      "id": "8848599e-3ac0-4445-87e0-2f9ff1d50491",
      "name": "Date & Time / start_time"
    },
    {
      "parameters": {
        "operation": "formatDate",
        "date": "={{ Number($('Meta Ads Automation').first().json['End Date']) \n    ? new Date(Date.UTC(1899, 11, 30) + Number($('Meta Ads Automation').first().json['End Date']) * 86400000).toISOString() \n    : '' }}",
        "format": "custom",
        "customFormat": "yyyy-MM-dd'T'HH:mm:ss'Z'",
        "outputFieldName": "end_time",
        "options": {}
      },
      "type": "n8n-nodes-base.dateTime",
      "typeVersion": 2,
      "position": [
        11024,
        6240
      ],
      "id": "c6703849-81a5-4a92-a883-a931b45e1fff",
      "name": "Date & Time / end_time"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek",
          "mode": "list",
          "cachedResultName": "Meta Ads Automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 222526350,
          "mode": "list",
          "cachedResultName": "Son",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek/edit#gid=222526350"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Campaign Name": "={{ $('Mapping').item.json.campaign_name }}",
            "Campaign ID": "={{ $json.campaign_id }}"
          },
          "matchingColumns": [
            "Campaign Name"
          ],
          "schema": [
            {
              "id": "Sync",
              "displayName": "Sync",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Hotel",
              "displayName": "Hotel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Account ID",
              "displayName": "Account ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Campaign ID",
              "displayName": "Campaign ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Campaign Name",
              "displayName": "Campaign Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Objective",
              "displayName": "Objective",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Buying Type",
              "displayName": "Buying Type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Special Ad Categories",
              "displayName": "Special Ad Categories",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Budget",
              "displayName": "Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Lifetime Budget",
              "displayName": "Lifetime Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Campaign)",
              "displayName": "Status (Campaign)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Set ID",
              "displayName": "Ad Set ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Set Name",
              "displayName": "Ad Set Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Set Budget",
              "displayName": "Ad Set Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Start Date",
              "displayName": "Start Date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "End Date",
              "displayName": "End Date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Age_Min",
              "displayName": "Age_Min",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Age_Max",
              "displayName": "Age_Max",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Bid Strategy",
              "displayName": "Bid Strategy",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Bid Amount",
              "displayName": "Bid Amount",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Conversion Location",
              "displayName": "Conversion Location",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Optimization Goal",
              "displayName": "Optimization Goal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Platform",
              "displayName": "Platform",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Placements",
              "displayName": "Placements",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Billing Event",
              "displayName": "Billing Event",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Ad Set)",
              "displayName": "Status (Ad Set)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Pixel_ID",
              "displayName": "Pixel_ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "AD ID",
              "displayName": "AD ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Name",
              "displayName": "Ad Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Primary Text",
              "displayName": "Primary Text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Headline",
              "displayName": "Headline",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Description",
              "displayName": "Description",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "URL",
              "displayName": "URL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Call To Action",
              "displayName": "Call To Action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Call Number",
              "displayName": "Call Number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Ad)",
              "displayName": "Status (Ad)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "FB Page_ID",
              "displayName": "FB Page_ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "IG User_ID",
              "displayName": "IG User_ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Action",
              "displayName": "Action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Processed",
              "displayName": "Processed",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Last Error",
              "displayName": "Last Error",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Updated At",
              "displayName": "Updated At",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Warnings",
              "displayName": "Warnings",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Row No",
              "displayName": "Row No",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "locationDefine": {
            "values": {
              "headerRow": 2,
              "firstDataRow": 3
            }
          }
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        13120,
        6096
      ],
      "id": "a9b4ed97-3df3-4537-9c5b-f6ab38bb47a9",
      "name": "Write Campaign ID",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mD66ftl4vER2aF4b",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v23.0/act_{{ $json.account_id || $('Mapping').item.json.account_id }}/campaigns",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json._campaignBody) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        12720,
        6096
      ],
      "id": "0d198382-18cf-43cb-8c15-0f7d10c61b99",
      "name": "Camp Budget - Camp. Create",
      "credentials": {
        "httpHeaderAuth": {
          "id": "CJvY0TtXNRCZ9OMj",
          "name": "Yango ADS"
        },
        "httpBearerAuth": {
          "id": "sOyy3sRQl00RoMfF",
          "name": "FB Token"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v23.0/act_{{ $json.account_id || $('Mapping').item.json.account_id }}/campaigns",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json._campaignBody) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        12720,
        6480
      ],
      "id": "13daac61-9741-44b8-8836-a728f68d51c8",
      "name": "Ad Set Budget - Camp. Create"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek",
          "mode": "list",
          "cachedResultName": "Meta Ads Automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 222526350,
          "mode": "list",
          "cachedResultName": "Son",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek/edit#gid=222526350"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Campaign Name": "={{ $('Mapping').item.json.campaign_name }}",
            "Campaign ID": "={{ $('Ad Set Budget - Camp. Create').item.json.id }}",
            "Ad Set Name": "={{ $('Ad set name').item.json.adset_name }}"
          },
          "matchingColumns": [
            "Campaign Name"
          ],
          "schema": [
            {
              "id": "Account ID",
              "displayName": "Account ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Campaign ID",
              "displayName": "Campaign ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Campaign Name",
              "displayName": "Campaign Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Objective",
              "displayName": "Objective",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Buying Type",
              "displayName": "Buying Type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Special Ad Categories",
              "displayName": "Special Ad Categories",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Budget",
              "displayName": "Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Lifetime Budget",
              "displayName": "Lifetime Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Campaign)",
              "displayName": "Status (Campaign)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Campaign ID",
              "displayName": "Campaign ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Ad Set ID",
              "displayName": "Ad Set ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Set Name",
              "displayName": "Ad Set Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Ad Set Budget",
              "displayName": "Ad Set Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Start Date",
              "displayName": "Start Date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "End Date",
              "displayName": "End Date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Bid Strategy",
              "displayName": "Bid Strategy",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Conversion Location",
              "displayName": "Conversion Location",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Optimization Goal",
              "displayName": "Optimization Goal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Placements",
              "displayName": "Placements",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Billing Event",
              "displayName": "Billing Event",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Ad Set)",
              "displayName": "Status (Ad Set)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "AD ID",
              "displayName": "AD ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Name",
              "displayName": "Ad Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Primary Text",
              "displayName": "Primary Text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Headline",
              "displayName": "Headline",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Description",
              "displayName": "Description",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "URL",
              "displayName": "URL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Call To Action",
              "displayName": "Call To Action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Call Number",
              "displayName": "Call Number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Ad)",
              "displayName": "Status (Ad)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Action",
              "displayName": "Action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Processed",
              "displayName": "Processed",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Last Error",
              "displayName": "Last Error",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Updated At",
              "displayName": "Updated At",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Row No",
              "displayName": "Row No",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "locationDefine": {
            "values": {
              "headerRow": 2,
              "firstDataRow": 3
            }
          }
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        13120,
        6480
      ],
      "id": "17dbceb9-1e29-4dd7-8d55-76f1fa35509e",
      "name": "Write Campaign ID1",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mD66ftl4vER2aF4b",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "3cd67a8e-2dec-4dd3-a83c-a8532b123196",
                    "leftValue": "={{ $json.sync }}",
                    "rightValue": "sync",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "sync"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "create_campaign",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "44cec607-d254-4608-a8c3-9f341f73b9dd"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "create_campaign"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "03404db0-dcf2-4bc1-9d26-3d26355135de",
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "update",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "update"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "c528ffde-950d-4547-958f-07e36c6ff3c8",
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "none",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "none"
            }
          ]
        },
        "options": {
          "fallbackOutput": "none"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        12000,
        6208
      ],
      "id": "1c1f78e0-db21-42f4-936e-639f75c113b6",
      "name": "Action Router"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek",
          "mode": "list",
          "cachedResultName": "Meta Ads Automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 222526350,
          "mode": "list",
          "cachedResultName": "Son",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek/edit#gid=222526350"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Campaign ID": "={{ $('Camp Budget - Camp. Create').item.json.id }}",
            "Ad Set Name": "={{ $('Mapping').item.json.adset_name }}",
            "Ad Set ID": "={{ $json.id }}"
          },
          "matchingColumns": [
            "Ad Set Name"
          ],
          "schema": [
            {
              "id": "Account ID",
              "displayName": "Account ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Campaign ID",
              "displayName": "Campaign ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Campaign Name",
              "displayName": "Campaign Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Objective",
              "displayName": "Objective",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Buying Type",
              "displayName": "Buying Type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Special Ad Categories",
              "displayName": "Special Ad Categories",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Budget",
              "displayName": "Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Lifetime Budget",
              "displayName": "Lifetime Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Campaign)",
              "displayName": "Status (Campaign)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Set ID",
              "displayName": "Ad Set ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Ad Set Name",
              "displayName": "Ad Set Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Ad Set Budget",
              "displayName": "Ad Set Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Start Date",
              "displayName": "Start Date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "End Date",
              "displayName": "End Date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Bid Strategy",
              "displayName": "Bid Strategy",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Conversion Location",
              "displayName": "Conversion Location",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Optimization Goal",
              "displayName": "Optimization Goal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Placements",
              "displayName": "Placements",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Billing Event",
              "displayName": "Billing Event",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Ad Set)",
              "displayName": "Status (Ad Set)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "AD ID",
              "displayName": "AD ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Name",
              "displayName": "Ad Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Primary Text",
              "displayName": "Primary Text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Headline",
              "displayName": "Headline",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Description",
              "displayName": "Description",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "URL",
              "displayName": "URL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Call To Action",
              "displayName": "Call To Action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Call Number",
              "displayName": "Call Number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Ad)",
              "displayName": "Status (Ad)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Action",
              "displayName": "Action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Processed",
              "displayName": "Processed",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Last Error",
              "displayName": "Last Error",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Updated At",
              "displayName": "Updated At",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Row No",
              "displayName": "Row No",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "locationDefine": {
            "values": {
              "headerRow": 2,
              "firstDataRow": 3
            }
          }
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        13760,
        6096
      ],
      "id": "8b360049-a548-4842-868d-f3e4e5f52506",
      "name": "Write Ad Set ID",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mD66ftl4vER2aF4b",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v23.0/{{ $json.campaign_id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json[\"_campaignUpdateBody\"]}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        12880,
        7552
      ],
      "id": "e6b23b90-ad76-439f-a926-85e97ba98144",
      "name": "Camp Budget - Camp. update"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f62da611-6aa8-4a8f-b42a-1560a86cfb22",
              "leftValue": "={{ $json.budget_type }}",
              "rightValue": "Campaign Budget",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        12416,
        7808
      ],
      "id": "3e6f34fa-6bdc-4e9a-88e0-ab61c9419c7a",
      "name": "If Budget Level (Camp Budget)1"
    },
    {
      "parameters": {
        "jsCode": "\n// Code in JavaScript - Targeting Builder - v11 PERFECT FIX\n//  CRITICAL: Fixes duplicate platform bug and invalid position combinations\n\nreturn items.map((item) => {\n  const original = item.json || {};\n  \n  const placementRaw = (original.placement || original.Placements || '').toString();\n  const platformRaw = (original.platform || original.Platform || '').toString().toLowerCase();\n  const optimizationGoal = (original.optimization_goal || original['Optimization Goal'] || '').toString().toUpperCase();\n  const destinationType = (original.destination_type || original['Conversion Location'] || '').toString().toUpperCase();\n  \n  const choices = placementRaw.split(',').map(s => s.trim()).filter(Boolean);\n\n  let publisher_platforms = new Set(); // Use Set to prevent duplicates\n  let facebook_positions = new Set();\n  let instagram_positions = new Set();\n  let device_platforms = ['mobile'];\n  let geo_countries = ['TR'];\n\n  // Parse platform first\n  if (platformRaw.includes('both') || (platformRaw.includes('facebook') && platformRaw.includes('instagram'))) {\n    publisher_platforms.add('facebook');\n    publisher_platforms.add('instagram');\n    device_platforms = ['mobile', 'desktop'];\n  } else if (platformRaw.includes('facebook')) {\n    publisher_platforms.add('facebook');\n    device_platforms = ['mobile', 'desktop'];\n  } else if (platformRaw.includes('instagram')) {\n    publisher_platforms.add('instagram');\n    device_platforms = ['mobile']; // Instagram is mobile-only\n  }\n\n  // Parse placements\n  for (const c of choices) {\n    const cLower = c.toLowerCase();\n    \n    // Facebook placements\n    if (cLower.includes('facebook')) {\n      publisher_platforms.add('facebook');\n      if (cLower.includes('feed')) facebook_positions.add('feed');\n      if (cLower.includes('story') || cLower.includes('stories')) facebook_positions.add('story');\n      if (cLower.includes('reels')) facebook_positions.add('facebook_reels');\n      if (cLower.includes('marketplace')) facebook_positions.add('marketplace');\n    }\n    \n    // Instagram placements\n    if (cLower.includes('instagram')) {\n      publisher_platforms.add('instagram');\n      if (cLower.includes('feed') || cLower.includes('stream')) instagram_positions.add('stream');\n      if (cLower.includes('story') || cLower.includes('stories')) instagram_positions.add('story');\n      if (cLower.includes('reels')) instagram_positions.add('reels');\n      if (cLower.includes('explore')) instagram_positions.add('explore');\n    }\n  }\n\n  //  CRITICAL: Destination type restrictions\n  // PHONE_CALL (CALLS) - Only Facebook Feed allowed\n  if (destinationType === 'PHONE_CALL' || destinationType === 'CALLS') {\n    publisher_platforms = new Set(['facebook']);\n    facebook_positions = new Set(['stream']);\n    instagram_positions = new Set(); // Clear Instagram\n    device_platforms = ['mobile', 'desktop'];\n  }\n  \n  // MESSAGING_APPS (MESSAGING) - Only Facebook allowed, no Instagram\n  if (destinationType === 'MESSAGING_APPS' || destinationType === 'MESSAGING') {\n    publisher_platforms = new Set(['facebook']);\n    facebook_positions = new Set(['stream']);\n    instagram_positions = new Set(); // Clear Instagram - Messenger doesn't support Instagram positions\n    device_platforms = ['mobile', 'desktop'];\n  }\n\n  //  CRITICAL: REACH optimization has limited Instagram positions\n  // Only 'feed' and 'stream' (which is feed) are valid for REACH\n  if (optimizationGoal === 'REACH') {\n    // For REACH, only feed is reliably supported on Instagram\n    if (instagram_positions.size > 0) {\n      instagram_positions = new Set(['stream']);\n    }\n  }\n\n  // Convert Sets to Arrays\n  publisher_platforms = [...publisher_platforms];\n  facebook_positions = [...facebook_positions];\n  instagram_positions = [...instagram_positions];\n\n  // Defaults if empty\n  if (publisher_platforms.length === 0) {\n    publisher_platforms = ['facebook', 'instagram'];\n  }\n  if (facebook_positions.length === 0 && publisher_platforms.includes('facebook')) {\n    facebook_positions = ['stream'];\n  }\n  if (instagram_positions.length === 0 && publisher_platforms.includes('instagram')) {\n    instagram_positions = ['stream'];\n  }\n\n  // Age validation (13-65)\n  let age_min = parseInt(original.age_min || original.Age_Min || 18, 10);\n  let age_max = parseInt(original.age_max || original.Age_Max || 65, 10);\n  age_min = Math.max(13, Math.min(65, age_min));\n  age_max = Math.max(age_min, Math.min(65, age_max));\n\n  const targeting = {\n    age_min,\n    age_max,\n    geo_locations: { countries: geo_countries },\n    publisher_platforms,\n    device_platforms,\n    targeting_automation: { advantage_audience: 0 }\n  };\n\n  // Only add positions if platform is included\n  if (facebook_positions.length > 0 && publisher_platforms.includes('facebook')) {\n    targeting.facebook_positions = facebook_positions;\n  }\n  if (instagram_positions.length > 0 && publisher_platforms.includes('instagram')) {\n    targeting.instagram_positions = instagram_positions;\n  }\n\n  // Preserve ALL original fields and add targeting\n  item.json = {\n    ...original,\n    targeting: targeting,\n    _body: { targeting },\n    __debug_targeting_v11: {\n      original_platform: platformRaw,\n      original_placements: placementRaw,\n      destination_type: destinationType,\n      optimization_goal: optimizationGoal,\n      final_platforms: publisher_platforms,\n      final_fb_positions: facebook_positions,\n      final_ig_positions: instagram_positions\n    }\n  };\n\n  return item;\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        11808,
        6240
      ],
      "id": "4842a000-e95e-46f8-9b7b-d3908013fc11",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "800aa352-c8c8-4afa-8f4e-9753a8f2a695",
              "name": "adset_name",
              "value": "={{ $json.adset_name }}",
              "type": "string"
            },
            {
              "id": "dda65e68-eb3e-4e02-b382-53da9ddee169",
              "name": "",
              "value": "",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        11600,
        6240
      ],
      "id": "bc3bee0c-75ce-4a7a-a3f4-29021d1320f4",
      "name": "Ad set name"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        13136,
        6736
      ],
      "id": "60ec604e-47a2-4ef4-9f00-ea52ab70ece9",
      "name": "Merge",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "ab5239dc-93cf-4a33-90a1-0f14db411f67",
              "name": "id",
              "value": "={{ $json.id }}",
              "type": "string"
            },
            {
              "id": "8cbc1ef6-553f-4c65-af01-1a1919aab421",
              "name": "adset_name",
              "value": "={{ $('Write Campaign ID1').item.json['Ad Set Name'] }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        13728,
        6480
      ],
      "id": "5f1d038b-87cb-4c86-ba8c-1f9ddb9785e2",
      "name": "Ad Set Result Normalize"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek",
          "mode": "list",
          "cachedResultName": "Meta Ads Automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 222526350,
          "mode": "list",
          "cachedResultName": "Son",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek/edit#gid=222526350"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Ad Set Name": "={{ $json.final_adset_name }}",
            "Ad Set ID": "={{ $json.final_adset_id }}"
          },
          "matchingColumns": [
            "Ad Set Name"
          ],
          "schema": [
            {
              "id": "Account ID",
              "displayName": "Account ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Campaign ID",
              "displayName": "Campaign ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Campaign Name",
              "displayName": "Campaign Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Objective",
              "displayName": "Objective",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Buying Type",
              "displayName": "Buying Type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Special Ad Categories",
              "displayName": "Special Ad Categories",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Budget",
              "displayName": "Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Lifetime Budget",
              "displayName": "Lifetime Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Campaign)",
              "displayName": "Status (Campaign)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Set ID",
              "displayName": "Ad Set ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Ad Set Name",
              "displayName": "Ad Set Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Ad Set Budget",
              "displayName": "Ad Set Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Start Date",
              "displayName": "Start Date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "End Date",
              "displayName": "End Date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Age_Min",
              "displayName": "Age_Min",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Age_Max",
              "displayName": "Age_Max",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Bid Strategy",
              "displayName": "Bid Strategy",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Conversion Location",
              "displayName": "Conversion Location",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Optimization Goal",
              "displayName": "Optimization Goal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Placements",
              "displayName": "Placements",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Billing Event",
              "displayName": "Billing Event",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Ad Set)",
              "displayName": "Status (Ad Set)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "AD ID",
              "displayName": "AD ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Name",
              "displayName": "Ad Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Primary Text",
              "displayName": "Primary Text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Headline",
              "displayName": "Headline",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Description",
              "displayName": "Description",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "URL",
              "displayName": "URL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Call To Action",
              "displayName": "Call To Action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Call Number",
              "displayName": "Call Number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Ad)",
              "displayName": "Status (Ad)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Action",
              "displayName": "Action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Processed",
              "displayName": "Processed",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Last Error",
              "displayName": "Last Error",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Updated At",
              "displayName": "Updated At",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Row No",
              "displayName": "Row No",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "locationDefine": {
            "values": {
              "headerRow": 2,
              "firstDataRow": 3
            }
          }
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        13520,
        6736
      ],
      "id": "6bf59497-b49a-4565-a68e-ebedacfb63c3",
      "name": "Write Ad Set ID1",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mD66ftl4vER2aF4b",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "22dda5e9-41a7-4fe4-a358-7d84affa5d6f",
              "name": "final_adset_name",
              "value": "={{$json[\"adset_name\"] || $json[\"Ad Set Name\"]}}",
              "type": "string"
            },
            {
              "id": "fb227b50-0bba-4e3c-8a72-8a33a36ffde9",
              "name": "final_adset_id",
              "value": "={{$json[\"id\"]}}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        13328,
        6736
      ],
      "id": "fbaadeba-09f1-4867-811e-81c60ba41775",
      "name": "Finalize Set"
    },
    {
      "parameters": {
        "jsCode": "/**\n * NODE: Build Final Ad Set Body (CBO) - V10 DICTATOR MODE\n * MODE: \"Run Once for All Items\"\n * LOGIC: \n * 1. Maps User Friendly Strategy Names -> API ENUMS.\n * 2. THE SANITIZER: If 'bid_amount' is missing at the end, FORCE 'LOWEST_COST_WITHOUT_CAP'.\n * 3. Includes targeting_automation for v23.0 compliance.\n */\n\n// ============================================================\n// 1. DATA SYNCHRONIZATION\n// ============================================================\n\nconst metaItems = items; \nconst sourceItems = $('If Budget Level (Camp Budget)').all();\n\n// Veri saylar tutmuyorsa log d (Ama ilemi durdurma)\nif (metaItems.length !== sourceItems.length) {\n    console.log(`WARNING: Mismatch detected! Meta: ${metaItems.length} vs Sheet: ${sourceItems.length}. Checking logic...`);\n}\n\nconst returnItems = [];\n\n// ============================================================\n// 2. HELPER FUNCTIONS\n// ============================================================\n\nfunction clean(v) {\n  if (typeof v === 'string') {\n    return v.replace(/\\u00A0/g, ' ').replace(/\\r?\\n/g, ' ').trim().replace(/^=\"\\s*|\\s*\"$/g, '');\n  }\n  return v == null ? '' : v;\n}\n\nfunction getVal(obj, keyStr) {\n    if (!obj) return undefined;\n    const keys = Object.keys(obj);\n    const key = keys.find(k => k.toLowerCase() === keyStr.toLowerCase().trim());\n    return key ? obj[key] : undefined;\n}\n\nfunction parseDate(dateInput) {\n  if (!dateInput) return undefined;\n  const str = String(dateInput).trim();\n  if (/^\\d{1,2}\\.\\d{1,2}\\.\\d{4}/.test(str)) { // DD.MM.YYYY\n      const parts = str.split('.');\n      return new Date(parts[2], parts[1] - 1, parts[0]).toISOString();\n  }\n  if (str.includes('/') && !str.includes('.')) { // MM/DD/YYYY\n      const d = new Date(str);\n      return !isNaN(d.getTime()) ? d.toISOString() : undefined;\n  }\n  const num = Number(str); // Excel Serial\n  if (!isNaN(num) && num > 20000) {\n      const epoch = new Date(Date.UTC(1899, 11, 30));\n      return new Date(epoch.getTime() + num * 86400000).toISOString();\n  }\n  if (str.includes('T') && str.includes('-')) return str; // ISO\n  return undefined;\n}\n\nfunction parseMoney(val) {\n  if (!val) return 0;\n  let s = String(val).trim();\n  // \"1.000,50\" -> \"1000.50\" veya \"50,50\" -> \"50.50\"\n  if (s.includes('.') && s.includes(',')) {\n      s = s.replace(/\\./g, '').replace(/,/g, '.');\n  } else if (s.includes(',')) {\n      s = s.replace(/,/g, '.');\n  }\n  const n = parseFloat(s);\n  // Meta kuru ister (100 TRY = 10000)\n  return (isNaN(n) || n <= 0) ? 0 : Math.round(n * 100);\n}\n\n// Strateji evirici (Human -> API)\nfunction mapStrategy(userStrategy) {\n    const s = clean(userStrategy).toUpperCase();\n    if (s.includes('BID') && s.includes('CAP')) return 'LOWEST_COST_WITH_BID_CAP';\n    if (s.includes('COST') && s.includes('CAP')) return 'COST_CAP';\n    if (s.includes('TARGET')) return 'TARGET_COST';\n    return 'LOWEST_COST_WITHOUT_CAP'; // Varsaylan\n}\n\nfunction validateMetaParams(dType, bEvent, oGoal) {\n  if (dType === 'PHONE_CALL') return { billing_event: 'IMPRESSIONS', optimization_goal: 'QUALITY_CALL', forceFB: true };\n  if (dType === 'MESSAGING_APPS') {\n      const goal = (oGoal === 'LINK_CLICKS') ? 'CONVERSATIONS' : oGoal;\n      return { billing_event: 'IMPRESSIONS', optimization_goal: goal, forceFB: false };\n  }\n  let finalBilling = bEvent;\n  if (dType === 'WEBSITE') {\n      if (['CONVERSIONS', 'VALUE', 'LANDING_PAGE_VIEWS'].includes(oGoal)) finalBilling = 'IMPRESSIONS';\n      if (!['IMPRESSIONS', 'LINK_CLICKS'].includes(finalBilling)) finalBilling = 'IMPRESSIONS';\n  }\n  return { billing_event: finalBilling, optimization_goal: oGoal, forceFB: false };\n}\n\n// ============================================================\n// 3. MAIN LOOP\n// ============================================================\n\nfor (let i = 0; i < metaItems.length; i++) {\n    try {\n        const metaJson = metaItems[i].json;\n        // Eer index kaymas varsa (nadir durum), bo obje ile devam et, hata patlatma\n        const sheetJson = sourceItems[i] ? sourceItems[i].json : {};\n\n        if (!sheetJson || Object.keys(sheetJson).length === 0) {\n            console.log(`Skipping Index ${i}: No Source Data.`);\n            continue;\n        }\n\n        // --- 1. EXTRACT BASIC DATA ---\n        const campaignId = clean(metaJson.campaign_id || metaJson.id || metaJson['Campaign ID']);\n        const adSetName = clean(getVal(sheetJson, 'Ad Set Name') || getVal(sheetJson, 'adset_name'));\n        const status = clean(getVal(sheetJson, 'Status (Ad Set)') || getVal(sheetJson, 'status') || 'PAUSED').toUpperCase();\n        \n        // --- 2. BIDDING LOGIC (Raw) ---\n        const rawStrategy = getVal(sheetJson, 'Bid Strategy');\n        const rawAmount = getVal(sheetJson, 'Bid Amount');\n        \n        let apiStrategy = mapStrategy(rawStrategy); // evrilmi Strateji\n        let bidAmountKurus = parseMoney(rawAmount); // Hesaplanm Tutar\n\n        // --- 3. OTHER PARAMS ---\n        const convLoc = clean(getVal(sheetJson, 'Conversion Location') || 'WEBSITE').toUpperCase();\n        const rawBilling = clean(getVal(sheetJson, 'Billing Event') || 'IMPRESSIONS').toUpperCase();\n        const rawGoal = clean(getVal(sheetJson, 'Optimization Goal') || 'LINK_CLICKS').toUpperCase();\n        const platformStr = clean(getVal(sheetJson, 'Platform') || 'Both').toLowerCase();\n        const placementStr = clean(getVal(sheetJson, 'Placements') || 'AUTO').toLowerCase();\n        \n        const ageMinRaw = getVal(sheetJson, 'Age_Min') || getVal(sheetJson, 'age_min');\n        const ageMaxRaw = getVal(sheetJson, 'Age_Max') || getVal(sheetJson, 'age_max');\n        const endDateRaw = getVal(sheetJson, 'End Date') || getVal(sheetJson, 'end_time');\n        const startDateRaw = getVal(sheetJson, 'Start Date') || getVal(sheetJson, 'start_time');\n        \n        const pixelId = clean(getVal(sheetJson, 'Pixel_ID') || '').replace(/\\D/g, '');\n        const pageId = clean(getVal(sheetJson, 'FB Page_ID') || '').replace(/\\D/g, '');\n        const accountId = clean(getVal(sheetJson, 'Account ID') || getVal(sheetJson, 'account_id'));\n\n        // --- 4. VALIDATION & TARGETING ---\n        const destMap = { 'WEBSITE': 'WEBSITE', 'CALLS': 'PHONE_CALL', 'MESSAGING': 'MESSAGING_APPS', 'ON_AD': 'ON_AD', 'APP': 'APP' };\n        const destType = destMap[convLoc] || 'WEBSITE';\n        const validated = validateMetaParams(destType, rawBilling, rawGoal);\n\n        const targeting = {\n            geo_locations: { countries: ['TR'] },\n            age_min: parseInt(ageMinRaw) || 18,\n            age_max: parseInt(ageMaxRaw) || 65,\n            publisher_platforms: [],\n            facebook_positions: [],\n            instagram_positions: [],\n            device_platforms: ['mobile', 'desktop'],\n            targeting_automation: { advantage_audience: 0 }\n        };\n\n        let useFB = validated.forceFB || platformStr.includes('facebook') || platformStr.includes('both');\n        let useIG = !validated.forceFB && (platformStr.includes('instagram') || platformStr.includes('both'));\n        if (!useFB && !useIG) useFB = true;\n\n        if (useFB) targeting.publisher_platforms.push('facebook');\n        if (useIG) targeting.publisher_platforms.push('instagram');\n\n        if (placementStr !== 'auto' && placementStr !== '') {\n            if (useFB) {\n                if (placementStr.includes('feed')) targeting.facebook_positions.push('feed');\n                if (placementStr.includes('story')) targeting.facebook_positions.push('story');\n                if (placementStr.includes('reels')) targeting.facebook_positions.push('reels');\n                if (targeting.facebook_positions.length === 0) targeting.facebook_positions.push('feed');\n            }\n            if (useIG) {\n                if (placementStr.includes('feed')) targeting.instagram_positions.push('feed');\n                if (placementStr.includes('story')) targeting.instagram_positions.push('story');\n                if (placementStr.includes('reels')) targeting.instagram_positions.push('reels');\n                if (targeting.instagram_positions.length === 0) targeting.instagram_positions.push('feed');\n            }\n        } else {\n            delete targeting.publisher_platforms;\n            delete targeting.facebook_positions;\n            delete targeting.instagram_positions;\n            delete targeting.device_platforms;\n        }\n\n        let promotedObject = {};\n        if (destType === 'WEBSITE' && pixelId) {\n            promotedObject = { pixel_id: pixelId, custom_event_type: 'OTHER' };\n        } else if (['PHONE_CALL', 'MESSAGING_APPS', 'ON_AD'].includes(destType)) {\n            promotedObject = { page_id: pageId };\n        }\n\n        // --- 5. BUILD BODY ---\n        const finalBody = {\n            name: adSetName,\n            campaign_id: campaignId,\n            status: ['ACTIVE', 'PAUSED'].includes(status) ? status : 'PAUSED',\n            start_time: parseDate(startDateRaw),\n            end_time: parseDate(endDateRaw),\n            billing_event: validated.billing_event,\n            optimization_goal: validated.optimization_goal,\n            destination_type: destType,\n            targeting: targeting,\n            bid_strategy: apiStrategy // imdilik bunu koyuyoruz, aada kontrol edeceiz\n        };\n\n        if (bidAmountKurus > 0) {\n            finalBody.bid_amount = bidAmountKurus;\n        }\n\n        if (Object.keys(promotedObject).length > 0) finalBody.promoted_object = promotedObject;\n\n        // ============================================================\n        //  6. THE SANITIZER (DIKTATOR MODU) \n        // Hata 1815857'yi yok eden blok\n        // ============================================================\n        \n        // Kural: Eer finalBody iinde 'bid_amount' yoksa, stratejiyi ne olursa olsun ez.\n        if (!finalBody.hasOwnProperty('bid_amount')) {\n            // Para yoksa strateji ASLA Bid Cap olamaz.\n            finalBody.bid_strategy = 'LOWEST_COST_WITHOUT_CAP';\n        } \n        // Ekstra Gvenlik: Eer strateji Lowest Cost ise, iinde 'bid_amount' olsa bile sil (Meta bazen buna da kzar)\n        else if (finalBody.bid_strategy === 'LOWEST_COST_WITHOUT_CAP') {\n            delete finalBody.bid_amount;\n        }\n\n        // --- 7. OUTPUT ---\n        returnItems.push({\n            json: {\n                _finalBody: finalBody,\n                \n                // Passthrough\n                campaign_id: campaignId,\n                campaign_name: clean(getVal(sheetJson, 'Campaign Name')),\n                adset_name: adSetName,\n                objective: clean(getVal(sheetJson, 'Objective')),\n                buying_type: clean(getVal(sheetJson, 'Buying Type')),\n                special_ad_categories: clean(getVal(sheetJson, 'Special Ad Categories')),\n                budget_type: clean(getVal(sheetJson, 'Budget')),\n                lifetime_budget: clean(getVal(sheetJson, 'Lifetime Budget')),\n                campaign_status: clean(getVal(sheetJson, 'Status (Campaign)')),\n                \n                // Debug Info\n                _debug_sanitizer: {\n                    raw_strategy: rawStrategy,\n                    raw_amount: rawAmount,\n                    parsed_amount: bidAmountKurus,\n                    FINAL_STRATEGY: finalBody.bid_strategy,\n                    HAS_AMOUNT: finalBody.hasOwnProperty('bid_amount')\n                },\n                \n                account_id: accountId,\n                original_row_no: sheetJson['Row No']\n            }\n        });\n\n    } catch (err) {\n        returnItems.push({\n            json: { error: true, message: err.message, index: i }\n        });\n    }\n}\n\nreturn returnItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        13344,
        6096
      ],
      "id": "1484c374-2f36-4f29-8bd9-af3cadb96271",
      "name": "Build Final Ad Set Body"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "/**\n * Build Final Ad Set Body1 (ABO) - v20 ULTIMATE FIX\n * \n * Same as CBO but with daily_budget\n */\n\nconst clean = v => {\n  if (typeof v === 'string') {\n    return v.replace(/\\u00A0/g, ' ').replace(/\\r?\\n/g, ' ').trim().replace(/^=\"\\s*|\\s*\"$/g, '');\n  }\n  return v == null ? '' : v;\n};\n\nconst looseGet = (obj, keys) => {\n  if (!obj) return undefined;\n  const norm = s => String(s ?? '').toLowerCase().replace(/\\u00A0/g, ' ').replace(/[^a-z0-9]/g, '').trim();\n  const look = Object.fromEntries(Object.keys(obj || {}).map(k => [norm(k), k]));\n  for (const k of keys) {\n    const hit = look[norm(k)];\n    if (hit) return obj[hit];\n  }\n  return undefined;\n};\n\nfunction validateAndFixApiParams(destination_type, billing_event, optimization_goal) {\n  let fb = billing_event, fo = optimization_goal;\n  switch (destination_type) {\n    case 'PHONE_CALL': fb = 'IMPRESSIONS'; fo = 'QUALITY_CALL'; break;\n    case 'MESSAGING_APPS': fb = 'IMPRESSIONS'; if (!['CONVERSATIONS','LEAD_GENERATION','IMPRESSIONS'].includes(fo)) fo = 'CONVERSATIONS'; break;\n    case 'ON_AD': case 'ON_FACEBOOK': fb = 'IMPRESSIONS'; if (!['LEAD_GENERATION','POST_ENGAGEMENT','IMPRESSIONS','REACH','VIDEO_VIEWS'].includes(fo)) fo = 'LEAD_GENERATION'; break;\n    default: if (!['IMPRESSIONS','LINK_CLICKS'].includes(fb)) fb = 'IMPRESSIONS'; if (!['LINK_CLICKS','LANDING_PAGE_VIEWS','OFFSITE_CONVERSIONS','VALUE','IMPRESSIONS','REACH','CONVERSIONS'].includes(fo)) fo = 'LINK_CLICKS';\n  }\n  return { billing_event: fb, optimization_goal: fo };\n}\n\nfunction getPromotedObject(dt, og, pixelId, pageId) {\n  if (dt === 'PHONE_CALL' && pageId) return { page_id: pageId };\n  if (og === 'LEAD_GENERATION' && pageId) return { page_id: pageId };\n  if (['OFFSITE_CONVERSIONS','VALUE','CONVERSIONS'].includes(og) && pixelId) return { pixel_id: pixelId };\n  return null;\n}\n\n// ========== MAIN LOGIC ==========\nconst cur = item.json || {};\nconst idx = $itemIndex;\n\n//  v20: Get original data by $itemIndex from ABO filter\nlet originalData = {};\n\ntry {\n  const budgetItems = $('If Budget Level (Camp Budget)1').all() || [];\n  if (budgetItems[idx] && budgetItems[idx].json) {\n    originalData = budgetItems[idx].json;\n  }\n} catch (e) {}\n\nif (Object.keys(originalData).length === 0) {\n  try {\n    const codeItems = $('Code in JavaScript').all() || [];\n    const aboItems = codeItems.filter(it => {\n      const bt = (it.json.budget_type || '').toLowerCase();\n      return bt.includes('ad set');\n    });\n    if (aboItems[idx] && aboItems[idx].json) {\n      originalData = aboItems[idx].json;\n    }\n  } catch (e) {}\n}\n\nlet ACCOUNT_ID = '';\ntry { ACCOUNT_ID = $('Mapping')?.item?.json?.account_id || ''; } catch(e){}\nconst account_id = ACCOUNT_ID || originalData.account_id || originalData['Account ID'] || '';\n\nconst getData = (keys) => looseGet(originalData, keys);\n\nconst campaign_id = cur.campaign_id || cur['Campaign ID'] || '';\nconst campaign_name = cur.campaign_name || cur['Campaign Name'] || originalData.campaign_name || '';\nconst adset_name = getData(['Ad Set Name', 'adset_name']) || '';\nconst status_adset = (getData(['status_adset', 'Status (Ad Set)', 'status']) || 'PAUSED').toUpperCase();\n\nconst billing_event_raw = getData(['billing_event', 'Billing Event']) || 'IMPRESSIONS';\nconst optimization_goal_raw = getData(['optimization_goal', 'Optimization Goal']) || 'LINK_CLICKS';\nlet bid_strategy = getData(['bid_strategy', 'Bid Strategy']) || 'LOWEST_COST_WITHOUT_CAP';\n\nconst bid_amount_raw = getData(['bid_amount', 'Bid Amount', 'Bid Cap']);\nlet bid_amount = null;\nif (bid_amount_raw && !isNaN(Number(bid_amount_raw)) && Number(bid_amount_raw) > 0) {\n  bid_amount = Math.round(Number(bid_amount_raw) * 100);\n}\n\nconst BID_REQUIRED = ['LOWEST_COST_WITH_BID_CAP', 'COST_CAP', 'TARGET_COST'];\nif (BID_REQUIRED.includes(bid_strategy) && (!bid_amount || bid_amount <= 0)) {\n  bid_strategy = 'LOWEST_COST_WITHOUT_CAP';\n}\n\n//  ABO: Daily Budget (TRY  kuru)\nconst daily_budget_raw = getData(['daily_budget', 'Daily Budget', 'Ad Set Budget']);\nlet daily_budget = null;\nif (daily_budget_raw && !isNaN(Number(daily_budget_raw))) {\n  daily_budget = Math.round(Number(daily_budget_raw) * 100);\n  if (daily_budget < 10000) daily_budget = 10000;\n}\n\nlet start_time = originalData.start_time || getData(['start_time', 'Start Date']) || '';\nlet end_time = originalData.end_time || getData(['end_time', 'End Date']) || '';\nif (!start_time) start_time = new Date().toISOString();\nif (!end_time) end_time = new Date(new Date(start_time).getTime() + 30*24*60*60*1000).toISOString();\n\nlet age_min = Number(getData(['age_min', 'Age_Min']) || 18);\nlet age_max = Number(getData(['age_max', 'Age_Max']) || 65);\nage_min = Math.max(13, Math.min(65, age_min));\nage_max = Math.max(age_min, Math.min(65, age_max));\n\nconst convCell = getData(['conversion_location', 'Conversion Location', 'destination_type']) || 'WEBSITE';\nconst convNorm = String(convCell).toUpperCase();\nlet destination_type = 'WEBSITE';\nif (/APP/.test(convNorm)) destination_type = 'APP';\nelse if (/(MESSAGE|WHATSAPP|MESSENGER|DM|MESSAGING)/.test(convNorm)) destination_type = 'MESSAGING_APPS';\nelse if (/(ON_FACEBOOK|PROFILE|ON_AD)/.test(convNorm)) destination_type = 'ON_AD';\nelse if (/(CALL|PHONE|CALLS)/.test(convNorm)) destination_type = 'PHONE_CALL';\n\nconst validated = validateAndFixApiParams(destination_type, billing_event_raw, optimization_goal_raw);\nconst billing_event = validated.billing_event;\nconst optimization_goal = validated.optimization_goal;\n\nconst pixel_id = String(getData(['Pixel_ID', 'Pixel ID']) ?? '').replace(/[^\\d]/g, '') || undefined;\nconst page_id = String(getData(['FB Page_ID', 'page_id']) ?? '').replace(/[^\\d]/g, '') || undefined;\nconst promoted_object = getPromotedObject(destination_type, optimization_goal, pixel_id, page_id);\n\n// Targeting\nconst platformRaw = clean(getData(['platform', 'Platform']) || '').toLowerCase();\nconst placementRaw = clean(getData(['placement', 'Placements']) || '');\n\nlet useFacebook = false, useInstagram = false;\nif (platformRaw.includes('both')) { useFacebook = true; useInstagram = true; }\nelse if (platformRaw.includes('facebook') && platformRaw.includes('instagram')) { useFacebook = true; useInstagram = true; }\nelse if (platformRaw.includes('facebook')) { useFacebook = true; }\nelse if (platformRaw.includes('instagram')) { useInstagram = true; }\n\nif (placementRaw && !useFacebook && !useInstagram) {\n  const pl = placementRaw.toLowerCase();\n  if (pl.includes('facebook')) useFacebook = true;\n  if (pl.includes('instagram')) useInstagram = true;\n}\n\nif (!useFacebook && !useInstagram) useFacebook = true;\nif (destination_type === 'PHONE_CALL' || destination_type === 'MESSAGING_APPS') {\n  useFacebook = true; useInstagram = false;\n}\n\nconst publisher_platforms = [];\nconst facebook_positions = [];\nconst instagram_positions = [];\nlet device_platforms = ['mobile', 'desktop'];\n\nif (useFacebook) { publisher_platforms.push('facebook'); facebook_positions.push('feed'); }\nif (useInstagram) {\n  publisher_platforms.push('instagram');\n  if (!useFacebook) device_platforms = ['mobile'];\n  if (optimization_goal === 'REACH') { instagram_positions.push('stream'); }\n  else { instagram_positions.push('stream'); instagram_positions.push('story'); instagram_positions.push('reels'); }\n}\n\nconst targeting = {\n  age_min, age_max,\n  geo_locations: { countries: ['TR'] },\n  device_platforms,\n  publisher_platforms,\n  targeting_automation: { advantage_audience: 0 }\n};\nif (facebook_positions.length > 0) targeting.facebook_positions = facebook_positions;\nif (instagram_positions.length > 0) targeting.instagram_positions = instagram_positions;\n\nconst finalBody = {\n  name: adset_name || `Ad Set - ${new Date().toISOString().slice(0,10)}`,\n  campaign_id,\n  status: status_adset,\n  destination_type,\n  billing_event,\n  optimization_goal,\n  bid_strategy,\n  targeting,\n  start_time,\n  end_time\n};\n\nif (BID_REQUIRED.includes(bid_strategy) && bid_amount > 0) finalBody.bid_amount = bid_amount;\nif (daily_budget && daily_budget >= 10000) finalBody.daily_budget = daily_budget;\nif (promoted_object) finalBody.promoted_object = promoted_object;\n\nitem.json._finalBody = finalBody;\nitem.json.account_id = account_id;\nitem.json.__debug_v20_abo = { itemIndex: idx, adset_name, bid_strategy, daily_budget_kurus: daily_budget };\n\nreturn item;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        13344,
        6480
      ],
      "id": "39785104-492e-4b71-a540-9285daddba14",
      "name": "Build Final Ad Set Body1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v23.0/act_{{ $json.account_id || $('Mapping').item.json.account_id }}/ads",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json._finalAdBody}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        14176,
        6096
      ],
      "id": "5550cb41-58f9-42c3-8870-616dc5cc4677",
      "name": "Campaign Budget - Ad Create1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "CJvY0TtXNRCZ9OMj",
          "name": "Yango ADS"
        },
        "httpBearerAuth": {
          "id": "tNCH6fVpo6A0boq2",
          "name": "Bearer Auth account"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "\n/**\n * Build Final Ad Body - v10 PERFECT FIX\n * Output: item.json._finalAdBody\n *  CRITICAL: Preserves account_id for HTTP Request URL\n */\n\nfunction clean(v) {\n  if (typeof v === 'string') {\n    return v.replace(/\\u00A0/g, ' ').replace(/\\r?\\n/g, ' ').trim()\n      .replace(/^=\"\\s*|\\s*\"$/g, '');\n  }\n  return v == null ? '' : v;\n}\n\nfunction normalizeUrl(u) {\n  if (typeof u !== 'string') return '';\n  let s = clean(u);\n  if (!s) return '';\n  if (/^tel:/i.test(s)) return '';\n  if (/^www\\./i.test(s)) s = 'https://' + s;\n  if (!/^https?:\\/\\//i.test(s)) s = 'https://' + s;\n  try { return new URL(s).toString(); } catch { return s; }\n}\n\nfunction normalizePhone(input) {\n  if (typeof input !== 'string') return '';\n  let p = clean(input);\n  if (p.toLowerCase().startsWith('tel:')) {\n    let n = p.slice(4).replace(/[^0-9+]/g, '').replace(/^\\++/, '+');\n    if (n.charAt(0) !== '+') n = '+' + n;\n    return 'tel:' + n;\n  }\n  let n = p.replace(/[^0-9+]/g, '').replace(/^\\++/, '+');\n  if (n.charAt(0) !== '+') n = '+' + n;\n  return 'tel:' + n;\n}\n\nfunction looseGet(obj, keys) {\n  if (!obj) return undefined;\n  function norm(s) {\n    return String(s == null ? '' : s).toLowerCase()\n      .replace(/\\u00A0/g, ' ').replace(/[^a-z0-9]/g, '').trim();\n  }\n  const look = {};\n  Object.keys(obj).forEach(k => { look[norm(k)] = k; });\n  for (const cand of keys) {\n    const hit = look[norm(cand)];\n    if (hit) return obj[hit];\n  }\n  return undefined;\n}\n\nfunction appendUtm(base, params) {\n  const entries = Object.entries(params).filter(([, v]) => v != null && String(v).trim() !== '');\n  try {\n    const url = new URL(base);\n    for (const [k, v] of entries) url.searchParams.set(k, v);\n    return url.toString();\n  } catch {\n    if (!entries.length) return base;\n    const qs = entries.map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&');\n    return base + (base.includes('?') ? '&' : '?') + qs;\n  }\n}\n\nconst row = item.json || {};\n\n//  CRITICAL: Preserve account_id for HTTP Request URL\nconst account_id = clean(row.account_id || row['Account ID'] || '');\n\n// Get IDs\nconst adsetId = clean(row.adset_id || row['Ad Set ID'] || row.id || '');\nconst adName = clean(row['Ad Name'] || row.ad_name || `Ad - ${Date.now()}`);\nconst status = clean(row['Status (Ad)'] || row.status_ad || 'PAUSED').toUpperCase();\n\n// Page and Instagram IDs\nconst pageId = String(looseGet(row, ['FB Page_ID', 'FB Page Id', 'fb_page_id', 'page_id']) || '').replace(/[^\\d]/g, '');\nconst igUserId = String(looseGet(row, ['IG User_ID', 'IG User Id', 'ig_user_id', 'instagram_user_id']) || '').replace(/[^\\d]/g, '');\n\n// Creative content\nconst primaryText = clean(row['Primary Text'] || row.primary_text || row.message || '');\nconst headline = clean(row['Headline'] || row.headline || row.name || '');\nconst description = clean(row['Description'] || row.description || '');\nconst urlRaw = clean(row['URL'] || row.url || row.link || '');\nconst ctaType = clean(row['Call To Action'] || row.call_to_action || row.cta || 'LEARN_MORE').toUpperCase();\nconst callNumber = clean(row['Call Number'] || row.call_number || row.phone || '');\n\n// Normalize URL\nconst normalizedUrl = normalizeUrl(urlRaw);\n\n// UTM parameters\nconst platformRaw = clean(row['Platform'] || row.platform || 'meta').toLowerCase();\nconst adsetName = clean(row['Ad Set Name'] || row.adset_name || '');\n\nconst utmParams = {\n  utm_source: 'meta',\n  utm_medium: platformRaw.includes('instagram') && platformRaw.includes('facebook') ? 'both' : \n              platformRaw.includes('instagram') ? 'instagram' : 'facebook',\n  utm_campaign: 'ads',\n  utm_content: adsetName || adName\n};\n\nconst finalUrl = normalizedUrl ? appendUtm(normalizedUrl, utmParams) : '';\n\n// Call to action\nlet callToAction;\nif (ctaType === 'CALL_NOW' && callNumber) {\n  const phone = normalizePhone(callNumber);\n  callToAction = { type: 'CALL_NOW', value: { link: phone } };\n} else {\n  callToAction = { type: ctaType, value: { link: finalUrl || normalizedUrl || '' } };\n}\n\n// Build link_data\nconst linkData = {\n  link: finalUrl || normalizedUrl || 'https://example.com',\n  message: primaryText,\n  name: headline,\n  description: description,\n  call_to_action: callToAction\n};\n\n// Build object_story_spec\nconst objectStorySpec = {\n  page_id: pageId,\n  link_data: linkData\n};\n\nif (igUserId) {\n  objectStorySpec.instagram_actor_id = igUserId;\n}\n\n// Final ad body\nconst finalAdBody = {\n  name: adName,\n  adset_id: adsetId,\n  status: status,\n  creative: {\n    object_story_spec: objectStorySpec\n  }\n};\n\n//  CRITICAL: Preserve account_id and set all outputs\nitem.json._finalAdBody = finalAdBody;\nitem.json._adsetId = adsetId;\nitem.json.account_id = account_id;  // Pass to HTTP node\n\nreturn item;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        13968,
        6096
      ],
      "id": "c31a2037-092b-46b0-ab72-4b342ec0f9e4",
      "name": "Campaign Budget - Ad Set Create  Build Final Ad Body (CBO)"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek",
          "mode": "list",
          "cachedResultName": "Meta Ads Automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 222526350,
          "mode": "list",
          "cachedResultName": "Son",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek/edit#gid=222526350"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Campaign ID": "={{ $('Camp Budget - Camp. Create').item.json.id }}",
            "Ad Name": "={{ $('Mapping').item.json.ad_name }}",
            "AD ID": "={{ $json.id }}"
          },
          "matchingColumns": [
            "Ad Name"
          ],
          "schema": [
            {
              "id": "Account ID",
              "displayName": "Account ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Campaign ID",
              "displayName": "Campaign ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Campaign Name",
              "displayName": "Campaign Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Objective",
              "displayName": "Objective",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Buying Type",
              "displayName": "Buying Type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Special Ad Categories",
              "displayName": "Special Ad Categories",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Budget",
              "displayName": "Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Lifetime Budget",
              "displayName": "Lifetime Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Campaign)",
              "displayName": "Status (Campaign)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Set ID",
              "displayName": "Ad Set ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Set Name",
              "displayName": "Ad Set Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Set Budget",
              "displayName": "Ad Set Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Start Date",
              "displayName": "Start Date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "End Date",
              "displayName": "End Date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Bid Strategy",
              "displayName": "Bid Strategy",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Conversion Location",
              "displayName": "Conversion Location",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Optimization Goal",
              "displayName": "Optimization Goal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Placements",
              "displayName": "Placements",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Billing Event",
              "displayName": "Billing Event",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Ad Set)",
              "displayName": "Status (Ad Set)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "AD ID",
              "displayName": "AD ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Ad Name",
              "displayName": "Ad Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Primary Text",
              "displayName": "Primary Text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Headline",
              "displayName": "Headline",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Description",
              "displayName": "Description",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "URL",
              "displayName": "URL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Call To Action",
              "displayName": "Call To Action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Call Number",
              "displayName": "Call Number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Ad)",
              "displayName": "Status (Ad)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Action",
              "displayName": "Action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Processed",
              "displayName": "Processed",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Last Error",
              "displayName": "Last Error",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Updated At",
              "displayName": "Updated At",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Row No",
              "displayName": "Row No",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "locationDefine": {
            "values": {
              "headerRow": 2,
              "firstDataRow": 3
            }
          }
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        14368,
        6096
      ],
      "id": "7b6fac58-cc4c-4315-aee2-29a2be906181",
      "name": "Write Ad ID",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mD66ftl4vER2aF4b",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "\n// Carry Row & Sheet - v10 PERFECT FIX\n//  CRITICAL: Carries ALL row info including account_id\n\nconst mapRow = $('Mapping')?.item?.json ?? {};\nconst sheetRow = $('Meta Ads Automation')?.item?.json ?? {};\nconst prevItem = item.json || {};\n\nfunction pickFirst(...vals) {\n  for (const v of vals) {\n    if (v !== undefined && v !== null && String(v).trim() !== '') {\n      return String(v).trim();\n    }\n  }\n  return '';\n}\n\nfunction clean(v) {\n  if (typeof v !== 'string') return v == null ? '' : String(v);\n  return v.replace(/\\u00A0/g, ' ').replace(/\\r?\\n/g, ' ').trim()\n    .replace(/^=\"\\s*|\\s*\"$/g, '');\n}\n\n//  CRITICAL: Get account_id from all possible sources\nconst account_id = clean(pickFirst(\n  mapRow.account_id,\n  mapRow['Account ID'], \n  sheetRow.account_id,\n  sheetRow['Account ID'],\n  prevItem.account_id,\n  prevItem['Account ID']\n));\n\nif (!account_id) {\n  console.log('WARNING: account_id is empty!');\n  console.log('mapRow:', JSON.stringify(mapRow));\n  console.log('sheetRow:', JSON.stringify(sheetRow));\n}\n\n// Build carried data object with ALL necessary fields\nconst carried = {\n  account_id: account_id,\n  campaign_id: clean(pickFirst(mapRow.campaign_id, mapRow['Campaign ID'], sheetRow['Campaign ID'], prevItem.campaign_id, prevItem.id)),\n  campaign_name: clean(pickFirst(mapRow.campaign_name, mapRow['Campaign Name'], sheetRow['Campaign Name'], prevItem.campaign_name)),\n  adset_id: clean(pickFirst(mapRow.adset_id, mapRow['Ad Set ID'], sheetRow['Ad Set ID'], prevItem.adset_id, prevItem.id)),\n  adset_name: clean(pickFirst(mapRow.adset_name, mapRow['Ad Set Name'], sheetRow['Ad Set Name'], prevItem.adset_name)),\n  ad_id: clean(pickFirst(mapRow.ad_id, mapRow['AD ID'], sheetRow['AD ID'], prevItem.ad_id)),\n  ad_name: clean(pickFirst(mapRow.ad_name, mapRow['Ad Name'], sheetRow['Ad Name'], prevItem.ad_name)),\n  row_no: clean(pickFirst(mapRow.row_no, mapRow['Row No'], sheetRow['Row No'], sheetRow.row_number, prevItem.row_no)),\n  budget_type: clean(pickFirst(mapRow.budget_type, mapRow['Budget'], sheetRow['Budget'], prevItem.budget_type)),\n  \n  // All other fields\n  objective: clean(pickFirst(mapRow.objective, mapRow['Objective'], sheetRow['Objective'], prevItem.objective)),\n  buying_type: clean(pickFirst(mapRow.buying_type, mapRow['Buying Type'], sheetRow['Buying Type'], prevItem.buying_type)),\n  status: clean(pickFirst(mapRow.status, mapRow['Status (Campaign)'], sheetRow['Status (Campaign)'], prevItem.status)),\n  status_campaign: clean(pickFirst(mapRow.status_campaign, mapRow['Status (Campaign)'], sheetRow['Status (Campaign)'], prevItem.status_campaign)),\n  status_adset: clean(pickFirst(mapRow.status_adset, mapRow['Status (Ad Set)'], sheetRow['Status (Ad Set)'], prevItem.status_adset)),\n  status_ad: clean(pickFirst(mapRow.status_ad, mapRow['Status (Ad)'], sheetRow['Status (Ad)'], prevItem.status_ad)),\n  \n  special_ad_categories: clean(pickFirst(mapRow.special_ad_categories, mapRow['Special Ad Categories'], sheetRow['Special Ad Categories'], prevItem.special_ad_categories)),\n  bid_strategy: clean(pickFirst(mapRow.bid_strategy, mapRow['Bid Strategy'], sheetRow['Bid Strategy'], prevItem.bid_strategy)),\n  daily_budget: clean(pickFirst(mapRow.daily_budget, mapRow['Ad Set Budget'], sheetRow['Ad Set Budget'], prevItem.daily_budget)),\n  lifetime_budget: clean(pickFirst(mapRow.lifetime_budget, mapRow['Lifetime Budget'], sheetRow['Lifetime Budget'], prevItem.lifetime_budget)),\n  \n  // Dates\n  start_time: clean(pickFirst(mapRow.start_time, mapRow['Start Date'], sheetRow['Start Date'], prevItem.start_time)),\n  end_time: clean(pickFirst(mapRow.end_time, mapRow['End Date'], sheetRow['End Date'], prevItem.end_time)),\n  \n  // Targeting\n  age_min: clean(pickFirst(mapRow.age_min, mapRow['Age_Min'], sheetRow['Age_Min'], prevItem.age_min)),\n  age_max: clean(pickFirst(mapRow.age_max, mapRow['Age_Max'], sheetRow['Age_Max'], prevItem.age_max)),\n  conversion_location: clean(pickFirst(mapRow.conversion_location, mapRow['Conversion Location'], sheetRow['Conversion Location'], prevItem.conversion_location)),\n  optimization_goal: clean(pickFirst(mapRow.optimization_goal, mapRow['Optimization Goal'], sheetRow['Optimization Goal'], prevItem.optimization_goal)),\n  billing_event: clean(pickFirst(mapRow.billing_event, mapRow['Billing Event'], sheetRow['Billing Event'], prevItem.billing_event)),\n  platform: clean(pickFirst(mapRow.platform, mapRow['Platform'], sheetRow['Platform'], prevItem.platform)),\n  placement: clean(pickFirst(mapRow.placement, mapRow['Placements'], sheetRow['Placements'], prevItem.placement)),\n  \n  // IDs\n  fb_page_id: clean(pickFirst(mapRow.fb_page_id, mapRow['FB Page_ID'], sheetRow['FB Page_ID'], prevItem.fb_page_id)),\n  ig_user_id: clean(pickFirst(mapRow.ig_user_id, mapRow['IG User_ID'], sheetRow['IG User_ID'], prevItem.ig_user_id)),\n  pixel_id: clean(pickFirst(mapRow.pixel_id, mapRow['Pixel_ID'], sheetRow['Pixel_ID'], prevItem.pixel_id)),\n  \n  // Creative\n  primary_text: clean(pickFirst(mapRow.primary_text, mapRow['Primary Text'], sheetRow['Primary Text'], prevItem.primary_text)),\n  headline: clean(pickFirst(mapRow.headline, mapRow['Headline'], sheetRow['Headline'], prevItem.headline)),\n  description: clean(pickFirst(mapRow.description, mapRow['Description'], sheetRow['Description'], prevItem.description)),\n  url: clean(pickFirst(mapRow.url, mapRow['URL'], sheetRow['URL'], prevItem.url)),\n  call_to_action: clean(pickFirst(mapRow.call_to_action, mapRow['Call To Action'], sheetRow['Call To Action'], prevItem.call_to_action)),\n  call_number: clean(pickFirst(mapRow.call_number, mapRow['Call Number'], sheetRow['Call Number'], prevItem.call_number)),\n  \n  // Action\n  action: clean(pickFirst(mapRow.action, mapRow['Action'], sheetRow['Action'], prevItem.action)),\n};\n\n// Merge all data into item.json\nObject.assign(item.json, carried);\n\n// Debug info\nitem.json.__debug_carry_v10 = {\n  account_id_found: !!account_id,\n  account_id_value: account_id,\n  source_check: {\n    mapRow_account_id: mapRow.account_id || mapRow['Account ID'] || 'NOT_FOUND',\n    sheetRow_account_id: sheetRow.account_id || sheetRow['Account ID'] || 'NOT_FOUND'\n  }\n};\n\nreturn item;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        11424,
        6240
      ],
      "id": "a171bfc5-6086-4a93-b498-ffcf44f721a5",
      "name": "Carry Row & Sheet"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek",
          "mode": "list",
          "cachedResultName": "Meta Ads Automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 222526350,
          "mode": "list",
          "cachedResultName": "Son",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek/edit#gid=222526350"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Row No": "={{ $('Carry Row & Sheet').item.json['row no'] }}",
            "Action": "none"
          },
          "matchingColumns": [
            "Row No"
          ],
          "schema": [
            {
              "id": "Sync",
              "displayName": "Sync",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Hotel",
              "displayName": "Hotel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Account ID",
              "displayName": "Account ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Campaign ID",
              "displayName": "Campaign ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Campaign Name",
              "displayName": "Campaign Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Objective",
              "displayName": "Objective",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Buying Type",
              "displayName": "Buying Type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Special Ad Categories",
              "displayName": "Special Ad Categories",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Budget",
              "displayName": "Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Lifetime Budget",
              "displayName": "Lifetime Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Campaign)",
              "displayName": "Status (Campaign)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Set ID",
              "displayName": "Ad Set ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Set Name",
              "displayName": "Ad Set Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Set Budget",
              "displayName": "Ad Set Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Start Date",
              "displayName": "Start Date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "End Date",
              "displayName": "End Date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Age_Min",
              "displayName": "Age_Min",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Age_Max",
              "displayName": "Age_Max",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Bid Strategy",
              "displayName": "Bid Strategy",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Conversion Location",
              "displayName": "Conversion Location",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Optimization Goal",
              "displayName": "Optimization Goal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Platform",
              "displayName": "Platform",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Placements",
              "displayName": "Placements",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Billing Event",
              "displayName": "Billing Event",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Ad Set)",
              "displayName": "Status (Ad Set)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Pixel_ID",
              "displayName": "Pixel_ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "AD ID",
              "displayName": "AD ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Name",
              "displayName": "Ad Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Primary Text",
              "displayName": "Primary Text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Headline",
              "displayName": "Headline",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Description",
              "displayName": "Description",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "URL",
              "displayName": "URL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Call To Action",
              "displayName": "Call To Action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Call Number",
              "displayName": "Call Number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Ad)",
              "displayName": "Status (Ad)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "FB Page_ID",
              "displayName": "FB Page_ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "IG User_ID",
              "displayName": "IG User_ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Action",
              "displayName": "Action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Processed",
              "displayName": "Processed",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Last Error",
              "displayName": "Last Error",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Updated At",
              "displayName": "Updated At",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Warnings",
              "displayName": "Warnings",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Row No",
              "displayName": "Row No",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "locationDefine": {
            "values": {
              "headerRow": 2,
              "firstDataRow": 3
            }
          }
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        14544,
        6096
      ],
      "id": "71aa6e4a-e1ee-4883-9257-00cb724c9e95",
      "name": "Mark Action NONE (CBO)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mD66ftl4vER2aF4b",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "\n/**\n * Build Final Ad Body - v10 PERFECT FIX\n * Output: item.json._finalAdBody\n *  CRITICAL: Preserves account_id for HTTP Request URL\n */\n\nfunction clean(v) {\n  if (typeof v === 'string') {\n    return v.replace(/\\u00A0/g, ' ').replace(/\\r?\\n/g, ' ').trim()\n      .replace(/^=\"\\s*|\\s*\"$/g, '');\n  }\n  return v == null ? '' : v;\n}\n\nfunction normalizeUrl(u) {\n  if (typeof u !== 'string') return '';\n  let s = clean(u);\n  if (!s) return '';\n  if (/^tel:/i.test(s)) return '';\n  if (/^www\\./i.test(s)) s = 'https://' + s;\n  if (!/^https?:\\/\\//i.test(s)) s = 'https://' + s;\n  try { return new URL(s).toString(); } catch { return s; }\n}\n\nfunction normalizePhone(input) {\n  if (typeof input !== 'string') return '';\n  let p = clean(input);\n  if (p.toLowerCase().startsWith('tel:')) {\n    let n = p.slice(4).replace(/[^0-9+]/g, '').replace(/^\\++/, '+');\n    if (n.charAt(0) !== '+') n = '+' + n;\n    return 'tel:' + n;\n  }\n  let n = p.replace(/[^0-9+]/g, '').replace(/^\\++/, '+');\n  if (n.charAt(0) !== '+') n = '+' + n;\n  return 'tel:' + n;\n}\n\nfunction looseGet(obj, keys) {\n  if (!obj) return undefined;\n  function norm(s) {\n    return String(s == null ? '' : s).toLowerCase()\n      .replace(/\\u00A0/g, ' ').replace(/[^a-z0-9]/g, '').trim();\n  }\n  const look = {};\n  Object.keys(obj).forEach(k => { look[norm(k)] = k; });\n  for (const cand of keys) {\n    const hit = look[norm(cand)];\n    if (hit) return obj[hit];\n  }\n  return undefined;\n}\n\nfunction appendUtm(base, params) {\n  const entries = Object.entries(params).filter(([, v]) => v != null && String(v).trim() !== '');\n  try {\n    const url = new URL(base);\n    for (const [k, v] of entries) url.searchParams.set(k, v);\n    return url.toString();\n  } catch {\n    if (!entries.length) return base;\n    const qs = entries.map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&');\n    return base + (base.includes('?') ? '&' : '?') + qs;\n  }\n}\n\nconst row = item.json || {};\n\n//  CRITICAL: Preserve account_id for HTTP Request URL\nconst account_id = clean(row.account_id || row['Account ID'] || '');\n\n// Get IDs\nconst adsetId = clean(row.adset_id || row['Ad Set ID'] || row.id || '');\nconst adName = clean(row['Ad Name'] || row.ad_name || `Ad - ${Date.now()}`);\nconst status = clean(row['Status (Ad)'] || row.status_ad || 'PAUSED').toUpperCase();\n\n// Page and Instagram IDs\nconst pageId = String(looseGet(row, ['FB Page_ID', 'FB Page Id', 'fb_page_id', 'page_id']) || '').replace(/[^\\d]/g, '');\nconst igUserId = String(looseGet(row, ['IG User_ID', 'IG User Id', 'ig_user_id', 'instagram_user_id']) || '').replace(/[^\\d]/g, '');\n\n// Creative content\nconst primaryText = clean(row['Primary Text'] || row.primary_text || row.message || '');\nconst headline = clean(row['Headline'] || row.headline || row.name || '');\nconst description = clean(row['Description'] || row.description || '');\nconst urlRaw = clean(row['URL'] || row.url || row.link || '');\nconst ctaType = clean(row['Call To Action'] || row.call_to_action || row.cta || 'LEARN_MORE').toUpperCase();\nconst callNumber = clean(row['Call Number'] || row.call_number || row.phone || '');\n\n// Normalize URL\nconst normalizedUrl = normalizeUrl(urlRaw);\n\n// UTM parameters\nconst platformRaw = clean(row['Platform'] || row.platform || 'meta').toLowerCase();\nconst adsetName = clean(row['Ad Set Name'] || row.adset_name || '');\n\nconst utmParams = {\n  utm_source: 'meta',\n  utm_medium: platformRaw.includes('instagram') && platformRaw.includes('facebook') ? 'both' : \n              platformRaw.includes('instagram') ? 'instagram' : 'facebook',\n  utm_campaign: 'ads',\n  utm_content: adsetName || adName\n};\n\nconst finalUrl = normalizedUrl ? appendUtm(normalizedUrl, utmParams) : '';\n\n// Call to action\nlet callToAction;\nif (ctaType === 'CALL_NOW' && callNumber) {\n  const phone = normalizePhone(callNumber);\n  callToAction = { type: 'CALL_NOW', value: { link: phone } };\n} else {\n  callToAction = { type: ctaType, value: { link: finalUrl || normalizedUrl || '' } };\n}\n\n// Build link_data\nconst linkData = {\n  link: finalUrl || normalizedUrl || 'https://example.com',\n  message: primaryText,\n  name: headline,\n  description: description,\n  call_to_action: callToAction\n};\n\n// Build object_story_spec\nconst objectStorySpec = {\n  page_id: pageId,\n  link_data: linkData\n};\n\nif (igUserId) {\n  objectStorySpec.instagram_actor_id = igUserId;\n}\n\n// Final ad body\nconst finalAdBody = {\n  name: adName,\n  adset_id: adsetId,\n  status: status,\n  creative: {\n    object_story_spec: objectStorySpec\n  }\n};\n\n//  CRITICAL: Preserve account_id and set all outputs\nitem.json._finalAdBody = finalAdBody;\nitem.json._adsetId = adsetId;\nitem.json.account_id = account_id;  // Pass to HTTP node\n\nreturn item;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        13696,
        6736
      ],
      "id": "3baa1a84-5e33-4a5f-8902-ab39a3524b83",
      "name": "Ad Set Budget - Ad Set Create  Build Final Ad Body (ABO)"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v23.0/act_{{ $json.account_id || $('Mapping').item.json.account_id }}/ads",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json._finalAdBody}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        13888,
        6736
      ],
      "id": "94a17714-9ca6-43aa-8ccf-26a856643aec",
      "name": "Ad Set Budget - Ad Create"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek",
          "mode": "list",
          "cachedResultName": "Meta Ads Automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 222526350,
          "mode": "list",
          "cachedResultName": "Son",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek/edit#gid=222526350"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Action": "none",
            "Row No": "={{ $('Carry Row & Sheet').item.json['row no'] }}"
          },
          "matchingColumns": [
            "Row No"
          ],
          "schema": [
            {
              "id": "Hotel",
              "displayName": "Hotel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Account ID",
              "displayName": "Account ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Campaign ID",
              "displayName": "Campaign ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Campaign Name",
              "displayName": "Campaign Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Objective",
              "displayName": "Objective",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Buying Type",
              "displayName": "Buying Type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Special Ad Categories",
              "displayName": "Special Ad Categories",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Budget",
              "displayName": "Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Lifetime Budget",
              "displayName": "Lifetime Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Campaign)",
              "displayName": "Status (Campaign)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Set ID",
              "displayName": "Ad Set ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Set Name",
              "displayName": "Ad Set Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Set Budget",
              "displayName": "Ad Set Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Start Date",
              "displayName": "Start Date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "End Date",
              "displayName": "End Date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Age_Min",
              "displayName": "Age_Min",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Age_Max",
              "displayName": "Age_Max",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Bid Strategy",
              "displayName": "Bid Strategy",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Conversion Location",
              "displayName": "Conversion Location",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Optimization Goal",
              "displayName": "Optimization Goal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Platform",
              "displayName": "Platform",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Placements",
              "displayName": "Placements",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Billing Event",
              "displayName": "Billing Event",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Ad Set)",
              "displayName": "Status (Ad Set)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "AD ID",
              "displayName": "AD ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Name",
              "displayName": "Ad Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Primary Text",
              "displayName": "Primary Text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Headline",
              "displayName": "Headline",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Description",
              "displayName": "Description",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "URL",
              "displayName": "URL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Call To Action",
              "displayName": "Call To Action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Call Number",
              "displayName": "Call Number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Ad)",
              "displayName": "Status (Ad)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Page_ID",
              "displayName": "Page_ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Action",
              "displayName": "Action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Processed",
              "displayName": "Processed",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Last Error",
              "displayName": "Last Error",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Updated At",
              "displayName": "Updated At",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Row No",
              "displayName": "Row No",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "locationDefine": {
            "values": {
              "headerRow": 2,
              "firstDataRow": 3
            }
          }
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        14304,
        6736
      ],
      "id": "6516471b-0992-48e4-b2e5-13bf1ab7894b",
      "name": "Mark Action NONE (ABO)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mD66ftl4vER2aF4b",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek",
          "mode": "list",
          "cachedResultName": "Meta Ads Automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 222526350,
          "mode": "list",
          "cachedResultName": "Son",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek/edit#gid=222526350"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Ad Name": "={{ $('Mapping').item.json.ad_name }}",
            "AD ID": "={{ $json.id }}"
          },
          "matchingColumns": [
            "Ad Name"
          ],
          "schema": [
            {
              "id": "Hotel",
              "displayName": "Hotel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Account ID",
              "displayName": "Account ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Campaign ID",
              "displayName": "Campaign ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Campaign Name",
              "displayName": "Campaign Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Objective",
              "displayName": "Objective",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Buying Type",
              "displayName": "Buying Type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Special Ad Categories",
              "displayName": "Special Ad Categories",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Budget",
              "displayName": "Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Lifetime Budget",
              "displayName": "Lifetime Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Campaign)",
              "displayName": "Status (Campaign)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Set ID",
              "displayName": "Ad Set ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Set Name",
              "displayName": "Ad Set Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Set Budget",
              "displayName": "Ad Set Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Start Date",
              "displayName": "Start Date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "End Date",
              "displayName": "End Date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Age_Min",
              "displayName": "Age_Min",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Age_Max",
              "displayName": "Age_Max",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Bid Strategy",
              "displayName": "Bid Strategy",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Conversion Location",
              "displayName": "Conversion Location",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Optimization Goal",
              "displayName": "Optimization Goal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Platform",
              "displayName": "Platform",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Placements",
              "displayName": "Placements",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Billing Event",
              "displayName": "Billing Event",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Ad Set)",
              "displayName": "Status (Ad Set)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "AD ID",
              "displayName": "AD ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Ad Name",
              "displayName": "Ad Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Primary Text",
              "displayName": "Primary Text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Headline",
              "displayName": "Headline",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Description",
              "displayName": "Description",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "URL",
              "displayName": "URL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Call To Action",
              "displayName": "Call To Action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Call Number",
              "displayName": "Call Number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Ad)",
              "displayName": "Status (Ad)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Page_ID",
              "displayName": "Page_ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Action",
              "displayName": "Action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Processed",
              "displayName": "Processed",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Last Error",
              "displayName": "Last Error",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Updated At",
              "displayName": "Updated At",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Row No",
              "displayName": "Row No",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "locationDefine": {
            "values": {
              "headerRow": 2,
              "firstDataRow": 3
            }
          }
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        14096,
        6736
      ],
      "id": "a8b39910-ba23-4899-93eb-e82250697fbb",
      "name": "Write AD ID1",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mD66ftl4vER2aF4b",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v23.0/{{ $json.adset_id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json._finalBody}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        13280,
        7552
      ],
      "id": "c2c09aa3-b029-40de-a7cd-8c19f3c19da2",
      "name": "Campaign Budget - Ad Set Update"
    },
    {
      "parameters": {
        "url": "=https://graph.facebook.com/v23.0/{{ $json._sync.ids.ad_id }}?fields=\nname,status,creative{object_story_spec},\nadset{id,name,status,bid_strategy,optimization_goal,billing_event,start_time,end_time,daily_budget,lifetime_budget,targeting,promoted_object},\ncampaign{id,name,status,objective,buying_type,special_ad_categories,daily_budget,lifetime_budget,start_time,stop_time}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {}
          ]
        },
        "options": {}
      },
      "id": "67250e2e-11be-4e04-8606-99e7ad3135e3",
      "name": " Fetch from Meta",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        13216,
        5104
      ],
      "continueOnFail": true,
      "notes": "Meta'dan kampanya verilerini eker.\nAdSets dahil tm bilgileri alr.\nGoogle Sheets gncelleme iin kullanlr."
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "\n// Code in JavaScript - Sync - v9 PERFECT FIX\n// Normalizes data for Google Sheets sync\n\nconst row = $json;\n\nfunction norm(v) {\n  if (v == null) return '';\n  let s = String(v).trim();\n  // Clean Excel formulas\n  if (s.startsWith('=\"') && s.endsWith('\"')) {\n    s = s.slice(2, -1);\n  }\n  return s;\n}\n\nfunction formatDate(isoDate) {\n  if (!isoDate) return '';\n  try {\n    const d = new Date(isoDate);\n    if (isNaN(d.getTime())) return '';\n    return d.toISOString().split('T')[0];\n  } catch {\n    return '';\n  }\n}\n\n// Build sync data\nconst syncData = {\n  'Account ID': norm(row['Account ID'] || row.account_id || ''),\n  'Campaign ID': norm(row['Campaign ID'] || row.campaign_id || row.id || ''),\n  'Campaign Name': norm(row['Campaign Name'] || row.campaign_name || row.name || ''),\n  'Status (Campaign)': norm(row['Status (Campaign)'] || row.status || ''),\n  \n  'Ad Set ID': norm(row['Ad Set ID'] || row.adset_id || ''),\n  'Ad Set Name': norm(row['Ad Set Name'] || row.adset_name || ''),\n  'Status (Ad Set)': norm(row['Status (Ad Set)'] || row.status_adset || ''),\n  \n  'AD ID': norm(row['AD ID'] || row.ad_id || ''),\n  'Ad Name': norm(row['Ad Name'] || row.ad_name || ''),\n  'Status (Ad)': norm(row['Status (Ad)'] || row.status_ad || ''),\n  \n  'Updated At': new Date().toISOString(),\n  'Row No': norm(row['Row No'] || row.row_no || ''),\n};\n\n// Return only non-empty values\nconst result = {};\nfor (const [k, v] of Object.entries(syncData)) {\n  if (v !== '') result[k] = v;\n}\n\nreturn { json: result };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        13024,
        5104
      ],
      "id": "fb5eceff-0562-4460-a372-a1dce25b19d7",
      "name": "Code in JavaScript - Sync"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek",
          "mode": "list",
          "cachedResultName": "Meta Ads Automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 222526350,
          "mode": "list",
          "cachedResultName": "Son",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek/edit#gid=222526350"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Row No": "={{ $json['row no'] }}",
            "Campaign Name": "={{ $json.campaign_name }}",
            "Objective": "={{ $json.objective }}",
            "Lifetime Budget": "={{ $json.lifetime_budget }}",
            "Status (Campaign)": "={{ $json.status }}",
            "Ad Set Name": "={{ $json.adset_name }}",
            "Ad Set Budget": "={{ $json.daily_budget }}",
            "Start Date": "={{ $json.start_time }}",
            "End Date": "={{ $json.end_time }}",
            "Age_Min": "={{ $json.age_min }}",
            "Age_Max": "={{ $json.age_max }}",
            "Bid Strategy": "={{ $json.bid_strategy }}",
            "Placements": "={{ $json.placement }}",
            "Platform": "={{ $json.platform }}",
            "Status (Ad Set)": "={{ $json.status_adset }}",
            "Ad Name": "={{ $json.ad_name }}",
            "Primary Text": "={{ $json.object_story_spec.link_data.message }}",
            "Headline": "={{ $json.object_story_spec.link_data.name }}",
            "Description": "={{ $json.object_story_spec.link_data.description }}",
            "URL": "={{ $json.object_story_spec.link_data.link }}",
            "Call To Action": "={{ $json.object_story_spec.link_data.call_to_action }}",
            "Call Number": "={{ $json.object_story_spec.link_data.call_to_action.value.link }}",
            "Status (Ad)": "={{ $json.status_ad }}",
            "Action": "={{ $json.action }}",
            "Processed": "={{ $json.processed }}",
            "Last Error": "={{ $json.last_error }}",
            "Updated At": "={{ $json.updated_at }}",
            "Page_ID": "={{ $json.fb_page_id }}",
            "AD ID": "={{ $json.ad_id }}",
            "Billing Event": "={{ $json.billing_event }}",
            "Conversion Location": "={{ $json.conversion_location }}",
            "Optimization Goal": "={{ $json._body.optimization_goal }}",
            "Ad Set ID": "={{ $json.adset_id }}",
            "Buying Type": "={{ $json.buying_type }}",
            "Budget": "={{ $json.budget_type }}",
            "Campaign ID": "={{ $json.campaign_id }}",
            "Account ID": "={{ $json.account_id }}"
          },
          "matchingColumns": [
            "Row No"
          ],
          "schema": [
            {
              "id": "Sync",
              "displayName": "Sync",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Hotel",
              "displayName": "Hotel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Account ID",
              "displayName": "Account ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Campaign ID",
              "displayName": "Campaign ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Campaign Name",
              "displayName": "Campaign Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Objective",
              "displayName": "Objective",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Buying Type",
              "displayName": "Buying Type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Special Ad Categories",
              "displayName": "Special Ad Categories",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Budget",
              "displayName": "Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Lifetime Budget",
              "displayName": "Lifetime Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Status (Campaign)",
              "displayName": "Status (Campaign)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Ad Set ID",
              "displayName": "Ad Set ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Ad Set Name",
              "displayName": "Ad Set Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Ad Set Budget",
              "displayName": "Ad Set Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Start Date",
              "displayName": "Start Date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "End Date",
              "displayName": "End Date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Age_Min",
              "displayName": "Age_Min",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Age_Max",
              "displayName": "Age_Max",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Bid Strategy",
              "displayName": "Bid Strategy",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Conversion Location",
              "displayName": "Conversion Location",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Optimization Goal",
              "displayName": "Optimization Goal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Platform",
              "displayName": "Platform",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Placements",
              "displayName": "Placements",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Billing Event",
              "displayName": "Billing Event",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Status (Ad Set)",
              "displayName": "Status (Ad Set)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "AD ID",
              "displayName": "AD ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Ad Name",
              "displayName": "Ad Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Primary Text",
              "displayName": "Primary Text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Headline",
              "displayName": "Headline",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Description",
              "displayName": "Description",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "URL",
              "displayName": "URL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Call To Action",
              "displayName": "Call To Action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Call Number",
              "displayName": "Call Number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Status (Ad)",
              "displayName": "Status (Ad)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Page_ID",
              "displayName": "Page_ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Action",
              "displayName": "Action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Processed",
              "displayName": "Processed",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Last Error",
              "displayName": "Last Error",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Updated At",
              "displayName": "Updated At",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Row No",
              "displayName": "Row No",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "locationDefine": {
            "values": {
              "headerRow": 2,
              "firstDataRow": 3
            }
          }
        }
      },
      "id": "21473fd2-a1f1-4d46-b251-dd767d95aecc",
      "name": "Sync to Google Sheets",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.4,
      "position": [
        12816,
        5104
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mD66ftl4vER2aF4b",
          "name": "Google Sheets account"
        }
      },
      "continueOnFail": true,
      "notes": "Meta'dan ekilen veriyi Google Sheets'e yazar.\nManuel deiiklikleri yakalar."
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {
          "clashHandling": {
            "values": {
              "resolveClash": "preferInput1"
            }
          },
          "includeUnpaired": true
        }
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        13232,
        5344
      ],
      "id": "01220b9d-051e-4b31-9f0b-30414efca416",
      "name": "Merge1"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// === helpers ===\nconst get = (obj, path, def='') => {\n  try { return path.split('.').reduce((o,k)=> (o==null?undefined:o[k]), obj) ?? def; }\n  catch { return def; }\n};\n\n// Excel/Sheets iin TEK biim: MM/DD/YYYY HH:mm:ss\nconst toSheetDate = (iso) => {\n  if (!iso) return '';\n  const d = new Date(iso);\n  if (isNaN(d.getTime())) return '';\n  const p = (n)=> String(n).padStart(2,'0');\n  // Saat/dakika/sn Meta'da genelde 00'lar; gerekirse aynen yaz\n  return `${p(d.getMonth()+1)}/${p(d.getDate())}/${d.getFullYear()} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;\n};\n\n// Tek artl \"tel:+905...\" ret\nconst normalizeTel = (s='') => {\n  let t = String(s).replace(/^=\"?tel:/i, '').replace(/\"$/,'').trim();\n  t = t.replace(/[^+\\d]/g, '');  // + ve rakam dn temizle\n  t = t.replace(/^\\++/, '+');    // birden fazla + -> tek +\n  if (!t.startsWith('+') && t) t = '+' + t;\n  return t ? `tel:${t}` : '';\n};\n\n// Platform / placement mapping\nconst mapPlatform = (arr=[]) =>\n  (arr||[]).map(p => p==='facebook' ? 'Facebook' : p==='instagram' ? 'Instagram' : p)\n           .filter(Boolean).join(', ');\n\nconst mapIg = (arr=[]) =>\n  (arr||[]).map(p => p==='stream' ? 'Instagram Feed'\n                     : p==='story' ? 'Instagram Stories'\n                     : p==='reels' ? 'Instagram Reels'\n                     : p)\n           .filter(Boolean).join(', ');\n\nconst mapFb = (arr=[]) =>\n  (arr||[]).map(p => p==='feed' ? 'Facebook Feed'\n                     : p==='story' ? 'Facebook Stories'\n                     : p==='video_feeds' ? 'Facebook Reels'\n                     : p)\n           .filter(Boolean).join(', ');\n\n// UTMleri sk (sheette ikinci kez UTM eklenmesin)\nconst stripUtm = (u='') => {\n  try { const url = new URL(u); url.search = ''; return url.toString(); } catch { return u; }\n};\n\n// === meta nesneleri ===\nconst ad     = $json;\nconst adset  = ad.adset || {};\nconst camp   = ad.campaign || {};\nconst tgt    = adset.targeting || {};\n\n// === creative + CTA ===\nconst ld = get(ad, 'creative.object_story_spec.link_data', {});\nconst primary     = ld.message || '';\nconst headline    = ld.name || '';\nconst description = ld.description || '';\nconst link        = ld.link || '';\n\nconst ctaTypeRaw = (get(ad, 'call_to_action.type', '') || '').toUpperCase();\nconst ctaLink    = get(ad, 'call_to_action.value.link', '');\n\n// CALL_NOW ise tel; deilse URL\nlet finalCTA  = ctaTypeRaw || '';\nlet finalURL  = '';\nlet finalCall = '';\n\nif (finalCTA === 'CALL_NOW') {\n  finalCall = normalizeTel(ctaLink); // -> \"tel:+905...\"\n  finalURL  = '';                    // tel reklamnda URL yazma\n} else {\n  finalCall = '';\n  finalURL  = stripUtm(link || ctaLink || '');\n}\n\n// === platform & placements ===\nconst platforms  = mapPlatform(tgt.publisher_platforms || []);\nconst placements = [ mapIg(tgt.instagram_positions||[]), mapFb(tgt.facebook_positions||[]) ]\n  .filter(Boolean).join(', ');\n\n// === adset bte & tarihler ===\nconst adsetBudget = adset.daily_budget || adset.lifetime_budget || '';\nconst startDate   = toSheetDate(adset.start_time || '');\nconst endDate     = toSheetDate(adset.end_time   || '');\n\n// === k (Sheet balklaryla bire bir) ===\n// NOT: Burada \"Row No\" YOK; elemeyi bozmamak iin.\nreturn {\n  // Campaign\n  'Campaign Name'        : camp.name || '',\n  'Objective'            : camp.objective || '',\n  'Buying Type'          : camp.buying_type || '',\n  'Special Ad Categories': (camp.special_ad_categories || []).join(', '),\n  'Lifetime Budget'      : camp.lifetime_budget || '',\n  'Status (Campaign)'    : camp.status || '',\n\n  // Ad Set\n  'Ad Set Name'          : adset.name || '',\n  'Ad Set Budget'        : adsetBudget,\n  'Start Date'           : startDate,\n  'End Date'             : endDate,\n  'Age_Min'              : get(tgt, 'age_min', ''),\n  'Age_Max'              : get(tgt, 'age_max', ''),\n  'Bid Strategy'         : adset.bid_strategy || '',\n  'Optimization Goal'    : adset.optimization_goal || '',\n  'Billing Event'        : adset.billing_event || '',\n  'Platform'             : platforms,\n  'Placements'           : placements,\n  'Status (Ad Set)'      : adset.status || '',\n\n  // Ad\n  'Ad Name'              : ad.name || '',\n  'Primary Text'         : primary,\n  'Headline'             : headline,\n  'Description'          : description,\n  'URL'                  : finalURL,   // saf link (UTM yok)\n  'Call To Action'       : finalCTA,   // dz string\n  'Call Number'          : finalCall,  // \"tel:+90...\" veya ''\n  'Status (Ad)'          : ad.status || '',\n\n  // ID'ler\n  'Campaign ID'          : camp.id || '',\n  'Ad Set ID'            : adset.id || '',\n  'AD ID'                : ad.id || '',\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        13392,
        5104
      ],
      "id": "d1c766bd-90d3-46f5-b135-1f07ea7006c7",
      "name": "Code in JavaScript - Fetch from Meta"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// === helpers ===\nconst norm = (v) => (v == null ? '' : String(v).trim());\nconst isFilled = (v) => norm(v) !== '';\nconst pick = (fresh, backup, original='') =>\n  isFilled(fresh) ? norm(fresh) : (isFilled(backup) ? norm(backup) : norm(original));\n\nconst now = () => {\n  const d = new Date();\n  const p = (n)=> String(n).padStart(2,'0');\n  return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;\n};\n\n// Tek artl + \"tel:\" prefiksli telefon ret\nconst fixTel = (s='') => {\n  if (!s) return '';\n  let t = String(s).replace(/^=\"?tel:/i,'').replace(/\"$/,'').trim();\n  t = t.replace(/[^+\\d]/g,'');     // rakam ve + dn temizle\n  t = t.replace(/^\\++/, '+');      // birden fazla +  tek +\n  if (!t.startsWith('+') && t) t = '+' + t;\n  return `tel:${t}`;\n};\n\n// --- toplama: errors & warnings ---\nconst errors = [];\nconst warnings = [];\nconst err  = (code, field, msg) => errors.push(`${code}[${field}]: ${msg}`);\nconst warn = (code, field, msg) => warnings.push(`${code}[${field}]: ${msg}`);\n\n// === kaynak ===\nconst J = item.json;\n\n// Row No garanti (string)\nconst rowNo = String(J['Row No'] ?? J.row_no ?? '');\nif (!rowNo) err('ROW_NO_MISSING', 'Row No', 'Eleme iin Row No bo.');\n\n// CTA: obje gelse bile stringe evir, JSON string durumunu da dzelt\nconst rawCTA = J['Call To Action'] ?? J.cta ?? '';\nlet cta = '';\n\nif (typeof rawCTA === 'string') {\n  const s = rawCTA.trim();\n\n  // {\"TYPE\":\"LEARN_MORE\", ...} gibi JSON string ise TYPE/type alann kullan\n  if (s.startsWith('{') && s.endsWith('}')) {\n    try {\n      const parsed = JSON.parse(s);\n      if (parsed && typeof parsed === 'object') {\n        cta = String(parsed.TYPE || parsed.type || '').toUpperCase();\n      }\n    } catch (e) {\n      // parse olmazsa normal string gibi devam\n    }\n  }\n\n  if (!cta) {\n    // Dz metin ise (LEARN_MORE, CALL_NOW vb)\n    cta = s.toUpperCase();\n  }\n} else if (rawCTA && typeof rawCTA === 'object') {\n  // Obje gelirse yine TYPE/type alanndan al\n  cta = String(rawCTA.TYPE || rawCTA.type || '').toUpperCase();\n}\n\n// URL & Call Number  sheetteki format koru, yenisi doluysa al\nlet urlSheet     = J.sheet_url;        // yedek\nlet urlIncoming  = J['URL'] ?? J.url;\nlet url          = pick(urlIncoming, urlSheet, J['URL']);\n\nlet callSheet    = J.sheet_callnum;    // yedek\nlet callIncoming = J['Call Number'] ?? J.call_number;\nlet callNumber   = pick(callIncoming, callSheet, J['Call Number']);\n\n// CTA mantna gre son dzeltme\nif (cta === 'CALL_NOW') {\n  const before = callNumber || (J?.call_to_action?.value?.link ?? '');\n  const fixed  = fixTel(before);\n  if (before && fixed && before !== fixed) {\n    warn('TEL_NORMALIZED', 'Call Number', `Dzenlendi: ${before}  ${fixed}`);\n  }\n  callNumber = fixed;\n  if (!callNumber) err('CTA_PHONE_MISSING','Call Number','CALL_NOW iken telefon yok/bozuk.');\n  // CALL_NOW iken URL yazma\n  if (isFilled(url)) warn('URL_IGNORED_CALLNOW','URL','CALL_NOW iken URL yazlmayacak.');\n  url = '';\n} else {\n  // linkli CTAlarda telefon bo\n  if (isFilled(callNumber)) warn('PHONE_IGNORED_LINK_CTA','Call Number','CALL_NOW deilken telefon temizlendi.');\n  callNumber = '';\n  // URL kontrol\n  if (!isFilled(url)) {\n    err('URL_REQUIRED', 'URL', `CTA=${cta || 'N/A'} iin URL bo.`);\n  } else if (!/^https?:\\/\\//i.test(url)) {\n    err('URL_SCHEME', 'URL', 'URL http/https ile balamyor.');\n  }\n  // UTM uyars (arka planda ekleniyorsa bilgi amal)\n  if (/(\\?|&)utm_/i.test(url)) {\n    warn('URL_UTM_PRESENT','URL','UTM parametreleri mevcut.');\n  }\n}\n\n// Platform/Placements  sheet deeri bo deilse koru\nconst platform   = pick(J['Platform'],   J.sheet_platform,     J['Platform']);\nconst placements = pick(J['Placements'], J.sheet_placements,   J['Placements']);\n\n// Kampanya & AdSet  sadece dolu gelenleri yaz, yoksa dokunma\nconst campaignName   = pick(J['Campaign Name'],   '', '');\nconst lifetimeBudget = pick(J['Lifetime Budget'], '', '');\nconst statusCampaign = pick(J['Status (Campaign)'], '', '');\nconst objective      = pick(J['Objective'], '', '');\n\nconst adsetName   = pick(J['Ad Set Name'],   '', '');\nconst adsetBudget = pick(J['Ad Set Budget'], '', '');\n// Tarihler: sheet formatn koru (JS Date parse ile YAZMAYIZ, sadece mantk kontrol yapp uyar/hata brakrz)\nconst startDate   = pick(J['Start Date'], J.sheet_start_date, J['Start Date']);\nconst endDate     = pick(J['End Date'],   J.sheet_end_date,   J['End Date']);\n\nconst ageMin      = pick(J['Age_Min'],       '', '');\nconst ageMax      = pick(J['Age_Max'],       '', '');\nconst bidStrategy = pick(J['Bid Strategy'],  '', '');\nconst optGoal     = pick(J['Optimization Goal'], '', '');\nconst billingEvent= pick(J['Billing Event'], '', '');\nconst statusAdset = pick(J['Status (Ad Set)'], '', '');\n\nconst adName      = pick(J['Ad Name'],      '', '');\nconst primaryText = pick(J['Primary Text'], '', '');\nconst headline    = pick(J['Headline'],     '', '');\nconst description = pick(J['Description'],  '', '');\nconst statusAd    = pick(J['Status (Ad)'],  '', '');\n\n// IDler (opsiyonel)\nconst campaign_id = J['Campaign ID'] ?? J.campaign_id ?? '';\nconst adset_id    = J['Ad Set ID']   ?? J.adset_id    ?? '';\nconst ad_id       = J['AD ID']       ?? J.ad_id       ?? '';\n\n// --- Hafif dorulamalar (format BOZMADAN) ---\n// Budget saysal kontrol (bo deilse)\nconst numish = (x)=> String(x).trim()==='' || /^[0-9]+$/.test(String(x).trim());\nif (!numish(lifetimeBudget)) err('BUDGET_NUM','Lifetime Budget','Saysal olmal (bo veya rakam).');\nif (!numish(adsetBudget))    err('BUDGET_NUM','Ad Set Budget','Saysal olmal (bo veya rakam).');\n\n// Age min/max say (bo deilse)\nif (isFilled(ageMin) && !/^\\d+$/.test(ageMin)) err('AGE_NUM','Age_Min','Say olmal.');\nif (isFilled(ageMax) && !/^\\d+$/.test(ageMax)) err('AGE_NUM','Age_Max','Say olmal.');\n\n// Tarih mant (sadece uyar/hata yaz, deeri aynen brak)\nconst parseLoose = (s)=> {\n  const t = String(s||'').trim();\n  if (!t) return null;\n  const d = new Date(t);\n  return isNaN(d.getTime()) ? null : d;\n};\nconst sd = parseLoose(startDate);\nconst ed = parseLoose(endDate);\nif (sd && ed && sd.getTime() >= ed.getTime()) err('DATE_ORDER','Start/End','Start Date  End Date.');\nif (!sd && isFilled(startDate)) warn('DATE_PARSE','Start Date','Tarih biimi tannmad, olduu gibi korunuyor.');\nif (!ed && isFilled(endDate))   warn('DATE_PARSE','End Date','Tarih biimi tannmad, olduu gibi korunuyor.');\n\n// Basit status dorulamas (bo deilse)\nconst validStatus = new Set(['ACTIVE','PAUSED','ARCHIVED']);\nif (isFilled(statusCampaign) && !validStatus.has(statusCampaign.toUpperCase())) {\n  warn('STATUS_UNUSUAL','Status (Campaign)', `Beklenmedik deer: ${statusCampaign}`);\n}\nif (isFilled(statusAdset) && !validStatus.has(statusAdset.toUpperCase())) {\n  warn('STATUS_UNUSUAL','Status (Ad Set)', `Beklenmedik deer: ${statusAdset}`);\n}\nif (isFilled(statusAd) && !validStatus.has(statusAd.toUpperCase())) {\n  warn('STATUS_UNUSUAL','Status (Ad)', `Beklenmedik deer: ${statusAd}`);\n}\n\n// IKI  yalnz izin verdiimiz balklar + log alanlar\nconst out = {\n  // match\n  'Row No': rowNo,\n\n  // Campaign\n  'Campaign Name':     campaignName,\n  'Lifetime Budget':   lifetimeBudget,\n  'Status (Campaign)': statusCampaign,\n  'Objective':         objective,   // balamak istersen\n\n  // Ad Set\n  'Ad Set Name':        adsetName,\n  'Ad Set Budget':      adsetBudget,\n  'Start Date':         startDate,  // format korunur\n  'End Date':           endDate,    // format korunur\n  'Age_Min':            ageMin,\n  'Age_Max':            ageMax,\n  'Bid Strategy':       bidStrategy,\n  'Optimization Goal':  optGoal,\n  'Billing Event':      billingEvent,\n  'Platform':           platform,\n  'Placements':         placements,\n  'Status (Ad Set)':    statusAdset,\n\n  // Ad\n  'Ad Name':        adName,\n  'Primary Text':   primaryText,\n  'Headline':       headline,\n  'Description':    description,\n  'URL':            url,\n  'Call To Action': cta,\n  'Call Number':    callNumber,\n  'Status (Ad)':    statusAd,\n\n  // IDler (opsiyonel  balamak istersen)\n  'Campaign ID': campaign_id,\n  'Ad Set ID':   adset_id,\n  'AD ID':       ad_id,\n};\n\n// Processed / Last Error / Warnings\nconst processedPrefix = errors.length\n  ? 'Failed'\n  : (warnings.length ? 'Synced with warnings' : 'Synced');\n\nout['Processed']  = `${processedPrefix} ${now()}`;\nout['Last Error'] = errors.join(' | ');\nout['Warnings']   = warnings.join(' | ');   // Sheetste bu balk iin bir stun atn varsayyorum\n\nreturn out;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        13408,
        5344
      ],
      "id": "680acffa-f678-422c-9da3-f9f4820be8fb",
      "name": "Code in JavaScript3"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek",
          "mode": "list",
          "cachedResultName": "Meta Ads Automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 222526350,
          "mode": "list",
          "cachedResultName": "Son",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek/edit#gid=222526350"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Row No": "={{ String($json['Row No'] ?? $json.row_no ?? '') }}",
            "Campaign Name": "={{$json['Campaign Name']}}",
            "Lifetime Budget": "={{ $json['Lifetime Budget'] }}",
            "Ad Set Budget": "={{ $json['Ad Set Budget'] }}",
            "Ad Set Name": "={{ $json['Ad Set Name'] }}",
            "Status (Campaign)": "={{ $json['Status (Campaign)'] }}",
            "Start Date": "={{ $json['Start Date'] }}",
            "End Date": "={{ $json['End Date'] }}",
            "Age_Min": "={{ $json.Age_Min }}",
            "Age_Max": "={{ $json.Age_Max }}",
            "Platform": "={{ $json.Platform }}",
            "Placements": "={{ $json.Placements }}",
            "Status (Ad Set)": "={{ $json['Status (Ad Set)'] }}",
            "Ad Name": "={{ $json['Ad Name'] }}",
            "Primary Text": "={{ $json['Primary Text'] }}",
            "Headline": "={{ $json.Headline }}",
            "Description": "={{ $json.Description }}",
            "URL": "={{ $json.URL }}",
            "Call To Action": "={{ $json['Call To Action'] }}",
            "Call Number": "={{ $json['Call Number'] }}",
            "Status (Ad)": "={{ $json['Status (Ad)'] }}",
            "Processed": "={{\n(() => {\n  const parts = new Intl.DateTimeFormat('en-GB', {\n    timeZone: 'Europe/Istanbul',\n    year: 'numeric', month: '2-digit', day: '2-digit',\n    hour: '2-digit', minute: '2-digit', second: '2-digit',\n    hour12: false\n  }).formatToParts(new Date()).reduce((a,p)=>(a[p.type]=p.value,a),{});\n  return `${parts.year}-${parts.month}-${parts.day} ${parts.hour}:${parts.minute}:${parts.second}`;\n})()\n}}",
            "Last Error": "={{ $json['Last Error'] }}",
            "Sync": "={{false}}",
            "Warnings": "={{ $json.Warnings }}"
          },
          "matchingColumns": [
            "Row No"
          ],
          "schema": [
            {
              "id": "Sync",
              "displayName": "Sync",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Hotel",
              "displayName": "Hotel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Account ID",
              "displayName": "Account ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Campaign ID",
              "displayName": "Campaign ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Campaign Name",
              "displayName": "Campaign Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Objective",
              "displayName": "Objective",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Buying Type",
              "displayName": "Buying Type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Special Ad Categories",
              "displayName": "Special Ad Categories",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Budget",
              "displayName": "Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Lifetime Budget",
              "displayName": "Lifetime Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Status (Campaign)",
              "displayName": "Status (Campaign)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Ad Set ID",
              "displayName": "Ad Set ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Set Name",
              "displayName": "Ad Set Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Ad Set Budget",
              "displayName": "Ad Set Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Start Date",
              "displayName": "Start Date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "End Date",
              "displayName": "End Date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Age_Min",
              "displayName": "Age_Min",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Age_Max",
              "displayName": "Age_Max",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Bid Strategy",
              "displayName": "Bid Strategy",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Conversion Location",
              "displayName": "Conversion Location",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Optimization Goal",
              "displayName": "Optimization Goal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Platform",
              "displayName": "Platform",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Placements",
              "displayName": "Placements",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Billing Event",
              "displayName": "Billing Event",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Ad Set)",
              "displayName": "Status (Ad Set)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "AD ID",
              "displayName": "AD ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Name",
              "displayName": "Ad Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Primary Text",
              "displayName": "Primary Text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Headline",
              "displayName": "Headline",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Description",
              "displayName": "Description",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "URL",
              "displayName": "URL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Call To Action",
              "displayName": "Call To Action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Call Number",
              "displayName": "Call Number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Status (Ad)",
              "displayName": "Status (Ad)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Page_ID",
              "displayName": "Page_ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Action",
              "displayName": "Action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Processed",
              "displayName": "Processed",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Last Error",
              "displayName": "Last Error",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Updated At",
              "displayName": "Updated At",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Warnings",
              "displayName": "Warnings",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Row No",
              "displayName": "Row No",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "cellFormat": "USER_ENTERED",
          "locationDefine": {
            "values": {
              "headerRow": 2,
              "firstDataRow": 3
            }
          }
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        13600,
        5344
      ],
      "id": "bfc1edbf-3026-4653-bdcd-eb7cbe975def",
      "name": "Sync to Google Sheets - Fetch from Meta",
      "notesInFlow": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mD66ftl4vER2aF4b",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        12608,
        5104
      ],
      "id": "ead006df-1f05-4d5b-825a-5ccbd15bbaa0",
      "name": "Schedule Trigger"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "\n/**\n * Build CBO Campaign Update Body - v9 PERFECT FIX\n * \n * Meta API EDITABLE fields for Campaign UPDATE:\n * - name\n * - status\n * - daily_budget (CBO only!)\n * - lifetime_budget\n */\n\nfunction clean(v) {\n  if (typeof v === 'string') {\n    return v.replace(/\\u00A0/g, ' ').replace(/\\r?\\n/g, ' ').trim()\n      .replace(/^=\"\\s*|\\s*\"$/g, '');\n  }\n  return v == null ? '' : v;\n}\n\nfunction normalizeStatus(s) {\n  const v = clean(s).toUpperCase();\n  return ['ACTIVE', 'PAUSED', 'DELETED'].includes(v) ? v : '';\n}\n\nfunction convertToKurus(tryAmount) {\n  if (tryAmount === '' || tryAmount == null) return null;\n  const num = parseFloat(tryAmount);\n  if (isNaN(num) || num < 1) return null;\n  const kurus = Math.round(num * 100);\n  return kurus >= 10000 ? String(kurus) : '10000';\n}\n\nconst row = item.json || {};\n\n// Only process CBO rows\nconst budgetType = clean(row['Budget'] || row.budget_type || '').toLowerCase();\nif (budgetType !== 'campaign budget') {\n  item.json._skipCampaignUpdate = true;\n  item.json._campaignUpdateBody = {};\n  return item;\n}\n\n// Campaign ID (required)\nconst campaignId = clean(row['Campaign ID'] || row.campaign_id || '');\nif (!campaignId) {\n  item.json._skipCampaignUpdate = true;\n  item.json._campaignUpdateBody = {};\n  return item;\n}\n\n// Build update body - ONLY EDITABLE FIELDS\nconst updateBody = {};\n\n// Name\nconst name = clean(row['Campaign Name'] || row.campaign_name || '');\nif (name) updateBody.name = name;\n\n// Status\nconst status = normalizeStatus(row['Status (Campaign)'] || row.status_campaign || '');\nif (status) updateBody.status = status;\n\n//  CBO: Budget is at campaign level\nconst dailyBudget = convertToKurus(row['Ad Set Budget'] || row.daily_budget || '');\nconst lifetimeBudget = convertToKurus(row['Lifetime Budget'] || row.lifetime_budget || '');\nif (dailyBudget) updateBody.daily_budget = dailyBudget;\nif (lifetimeBudget) updateBody.lifetime_budget = lifetimeBudget;\n\nitem.json.campaign_id = campaignId;\nitem.json._campaignUpdateBody = updateBody;\nitem.json._skipCampaignUpdate = Object.keys(updateBody).length === 0;\n\nreturn item;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        12688,
        7552
      ],
      "id": "16846827-20d6-4a2a-9fcb-b2938fd71ec6",
      "name": "Build CBO Campaign Update Body"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "\n/**\n * Build Final Ad Set UPDATE Body (CBO) - v9 PERFECT FIX\n *\n * Meta API EDITABLE fields for AdSet UPDATE:\n * - name\n * - status\n * - start_time\n * - end_time\n * \n *  CBO: NO budget fields (budget is at campaign level)\n *  NON-EDITABLE: billing_event, optimization_goal, bid_strategy, targeting\n */\n\nfunction clean(v) {\n  if (typeof v === 'string') {\n    return v.replace(/\\u00A0/g, ' ').replace(/\\r?\\n/g, ' ').trim()\n      .replace(/^=\"\\s*|\\s*\"$/g, '');\n  }\n  return v == null ? '' : v;\n}\n\nfunction convertExcelDateToISO(excelDate) {\n  if (!excelDate || excelDate === '') return '';\n  if (typeof excelDate === 'string' && excelDate.includes('T')) return excelDate;\n  const num = Number(excelDate);\n  if (isNaN(num)) return '';\n  const epochStart = Date.UTC(1899, 11, 30);\n  const millisPerDay = 86400000;\n  return new Date(epochStart + num * millisPerDay).toISOString();\n}\n\nfunction normalizeStatus(s) {\n  const v = clean(s).toUpperCase();\n  return ['ACTIVE', 'PAUSED', 'DELETED'].includes(v) ? v : '';\n}\n\nconst row = item.json || {};\n\n// Check budget type - only process CBO\nconst budgetType = clean(row['Budget'] || row.budget_type || '').toLowerCase();\nif (budgetType !== 'campaign budget') {\n  item.json._skipAdsetUpdate = true;\n  item.json._adsetUpdateBody = {};\n  return item;\n}\n\n// Ad Set ID (required)\nconst adsetId = clean(row['Ad Set ID'] || row.adset_id || '');\nif (!adsetId) {\n  item.json._skipAdsetUpdate = true;\n  item.json._adsetUpdateBody = {};\n  return item;\n}\n\n// Build update body - ONLY EDITABLE FIELDS\nconst updateBody = {};\n\n// Name\nconst name = clean(row['Ad Set Name'] || row.adset_name || '');\nif (name) updateBody.name = name;\n\n// Status\nconst status = normalizeStatus(row['Status (Ad Set)'] || row.status_adset || '');\nif (status) updateBody.status = status;\n\n// Dates\nconst startTime = convertExcelDateToISO(row['Start Date'] || row.start_time || '');\nconst endTime = convertExcelDateToISO(row['End Date'] || row.end_time || '');\nif (startTime) updateBody.start_time = startTime;\nif (endTime) updateBody.end_time = endTime;\n\n//  CBO: NO daily_budget - budget is at campaign level\n\nitem.json._adsetId = adsetId;\nitem.json._adsetUpdateBody = updateBody;\nitem.json._skipAdsetUpdate = Object.keys(updateBody).length === 0;\n\nreturn item;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        13088,
        7552
      ],
      "id": "c2d73768-38ed-478c-8582-884d044c7c0f",
      "name": "Build Final Ad Set UPDATE Body (CBO)"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "\n// Build Ads UPDATE Bodies - v10 PERFECT FIX\n//  CRITICAL: Sets account_id for HTTP Request URLs\n\nconst cur = item.json || {};\n\n// Get Mapping row\nconst mappingItems = $items('Mapping', 0) || [];\nconst row = (mappingItems[$itemIndex] || {}).json || {};\nconst sheetItems = $items('Meta Ads Automation', 0) || [];\nconst sheetRow = (sheetItems[$itemIndex] || {}).json || {};\n\nfunction cleanCell(v) {\n  if (typeof v !== 'string') return v == null ? '' : String(v);\n  return v.replace(/\\u00A0/g, ' ').replace(/\\r?\\n/g, ' ').trim()\n    .replace(/^=\"\\s*|\\s*\"$/g, '');\n}\n\nfunction pickFirst(...vals) {\n  for (const v of vals) {\n    if (v !== undefined && v !== null && String(v).trim() !== '') return String(v).trim();\n  }\n  return '';\n}\n\nfunction normalizeUrl(u) {\n  if (typeof u !== 'string') return '';\n  let s = cleanCell(u);\n  if (!s) return '';\n  if (/^tel:/i.test(s)) return '';\n  if (/^www\\./i.test(s)) s = 'https://' + s;\n  if (!/^https?:\\/\\//i.test(s)) s = 'https://' + s;\n  try { return new URL(s).toString(); } catch { return s; }\n}\n\nfunction normalizePhone(input) {\n  if (typeof input !== 'string') return '';\n  let p = cleanCell(input);\n  if (p.toLowerCase().startsWith('tel:')) {\n    let n = p.slice(4).replace(/[^0-9+]/g, '').replace(/^\\++/, '+');\n    if (!n.startsWith('+')) n = '+' + n;\n    return 'tel:' + n;\n  }\n  let n = p.replace(/[^0-9+]/g, '').replace(/^\\++/, '+');\n  if (!n.startsWith('+')) n = '+' + n;\n  return 'tel:' + n;\n}\n\nfunction appendUtm(base, params) {\n  const entries = Object.entries(params).filter(([, v]) => v != null && String(v).trim() !== '');\n  try {\n    const url = new URL(base);\n    for (const [k, v] of entries) url.searchParams.set(k, v);\n    return url.toString();\n  } catch {\n    if (!entries.length) return base;\n    const qs = entries.map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&');\n    return base + (base.includes('?') ? '&' : '?') + qs;\n  }\n}\n\n//  CRITICAL: Get account_id for HTTP Request URL\nconst account_id = cleanCell(pickFirst(\n  cur.account_id, cur['Account ID'],\n  row.account_id, row['Account ID'],\n  sheetRow.account_id, sheetRow['Account ID']\n));\n\nconst adId = cleanCell(pickFirst(cur.ad_id, cur['AD ID'], row['AD ID'], row.ad_id, sheetRow['AD ID']));\nconst adsetId = cleanCell(pickFirst(cur.adset_id, cur['Ad Set ID'], row['Ad Set ID'], row.adset_id, sheetRow['Ad Set ID']));\n\nconst adName = cleanCell(pickFirst(cur.ad_name, cur['Ad Name'], row['Ad Name'], row.ad_name, sheetRow['Ad Name']));\nconst statusAd = cleanCell(pickFirst(cur.status_ad, cur['Status (Ad)'], row['Status (Ad)'], row.status_ad, sheetRow['Status (Ad)'])).toUpperCase();\n\nconst pageId = cleanCell(pickFirst(cur.fb_page_id, cur['FB Page_ID'], row['FB Page_ID'], row.fb_page_id, sheetRow['FB Page_ID'])).replace(/[^\\d]/g, '');\nconst igUserId = cleanCell(pickFirst(cur.ig_user_id, cur['IG User_ID'], row['IG User_ID'], row.instagram_user_id, sheetRow['IG User_ID'])).replace(/[^\\d]/g, '');\n\nconst primaryText = cleanCell(pickFirst(cur.primary_text, cur['Primary Text'], row['Primary Text'], sheetRow['Primary Text']));\nconst headline = cleanCell(pickFirst(cur.headline, cur['Headline'], row['Headline'], sheetRow['Headline']));\nconst description = cleanCell(pickFirst(cur.description, cur['Description'], row['Description'], sheetRow['Description']));\nconst urlRaw = cleanCell(pickFirst(cur.url, cur['URL'], row['URL'], row.url, sheetRow['URL']));\nconst ctaType = cleanCell(pickFirst(cur.call_to_action, cur['Call To Action'], row['Call To Action'], sheetRow['Call To Action']) || 'LEARN_MORE').toUpperCase();\nconst callNumber = cleanCell(pickFirst(cur.call_number, cur['Call Number'], row['Call Number'], sheetRow['Call Number']));\n\n// Build URL with UTM\nconst normalizedUrl = normalizeUrl(urlRaw);\nconst adsetName = cleanCell(pickFirst(cur.adset_name, cur['Ad Set Name'], row['Ad Set Name'], sheetRow['Ad Set Name']));\nconst platformRaw = cleanCell(pickFirst(cur.platform, cur['Platform'], row['Platform'], sheetRow['Platform']) || 'meta').toLowerCase();\n\nconst finalUrl = normalizedUrl ? appendUtm(normalizedUrl, {\n  utm_source: 'meta',\n  utm_medium: platformRaw.includes('instagram') && platformRaw.includes('facebook') ? 'both' :\n              platformRaw.includes('instagram') ? 'instagram' : 'facebook',\n  utm_campaign: 'ads',\n  utm_content: adsetName || adName\n}) : '';\n\n// CTA\nlet callToAction;\nif (ctaType === 'CALL_NOW' && callNumber) {\n  callToAction = { type: 'CALL_NOW', value: { link: normalizePhone(callNumber) } };\n} else {\n  callToAction = { type: ctaType, value: { link: finalUrl || normalizedUrl || '' } };\n}\n\n// 1) Ad Update Body (name + status only)\nconst adUpdateBody = {};\nif (adName) adUpdateBody.name = adName;\nif (['ACTIVE', 'PAUSED', 'DELETED'].includes(statusAd)) adUpdateBody.status = statusAd;\n\n// 2) Creative Body\nconst linkData = {\n  link: finalUrl || normalizedUrl || 'https://example.com',\n  message: primaryText,\n  name: headline,\n  description: description,\n  call_to_action: callToAction\n};\n\nconst objectStorySpec = { page_id: pageId, link_data: linkData };\nif (igUserId) objectStorySpec.instagram_actor_id = igUserId;\n\nconst creativeBody = {\n  name: `Creative - ${adName} - ${Date.now()}`,\n  object_story_spec: objectStorySpec\n};\n\n// 3) New Ad Body\nconst newAdBody = {\n  name: adName || `Ad - ${Date.now()}`,\n  adset_id: adsetId,\n  status: statusAd || 'PAUSED'\n};\n\n//  CRITICAL: Set all outputs including account_id\nitem.json.account_id = account_id;\nitem.json._adId = adId;\nitem.json._accountId = account_id;  // Also set _accountId for backwards compatibility\nitem.json._adsetId = adsetId;\nitem.json._adUpdateBody = adUpdateBody;\nitem.json._creativeBody = creativeBody;\nitem.json._newAdBody = newAdBody;\nitem.json._hasNameOrStatus = !!(adName || statusAd);\nitem.json._hasCreativeChanges = !!(primaryText || headline || description || urlRaw);\n\nreturn item;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        13488,
        7552
      ],
      "id": "c34bb0e7-00dc-4c9f-8791-651c5fc8b2ad",
      "name": "Build CBO Ads Update"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v23.0/{{ $json._adId }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json._adUpdateBody}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        13952,
        7328
      ],
      "id": "1b8b36c4-05cc-4550-8608-ddd91f4c3a89",
      "name": "Campaign Budget - Ad Update (Ad ID)"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v23.0/act_{{ $json.account_id || $('Mapping').item.json.account_id }}/adcreatives",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json._creativeBody}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        13744,
        7728
      ],
      "id": "650003c2-2462-4f41-88cb-49f2916e2031",
      "name": "Campaign Budget - Ad Update (Ad Creatives)"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v23.0/act_{{ $json.account_id || $('Mapping').item.json.account_id }}/ads\n",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"name\": \"{{$node['Build CBO Ads Update'].json._newAdBody.name}}\",\n  \"status\": \"{{$node['Build CBO Ads Update'].json._newAdBody.status}}\",\n  \"adset_id\": \"{{$node['Build CBO Ads Update'].json._newAdBody.adset_id}}\",\n  \"creative\": {\n    \"creative_id\": \"{{$json.id}}\"\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        13952,
        7728
      ],
      "id": "375f3b58-9715-4b34-be6a-81f3408a519c",
      "name": "Campaign Budget - Ad Update (New Ad Body)"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek",
          "mode": "list",
          "cachedResultName": "Meta Ads Automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 222526350,
          "mode": "list",
          "cachedResultName": "Son",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek/edit#gid=222526350"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Action": "none",
            "Row No": "={{ $('Carry Row & Sheet').item.json.row }}",
            "AD ID": "={{ $json.id }}"
          },
          "matchingColumns": [
            "Row No"
          ],
          "schema": [
            {
              "id": "Hotel",
              "displayName": "Hotel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Account ID",
              "displayName": "Account ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Campaign ID",
              "displayName": "Campaign ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Campaign Name",
              "displayName": "Campaign Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Objective",
              "displayName": "Objective",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Buying Type",
              "displayName": "Buying Type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Special Ad Categories",
              "displayName": "Special Ad Categories",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Budget",
              "displayName": "Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Lifetime Budget",
              "displayName": "Lifetime Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Campaign)",
              "displayName": "Status (Campaign)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Set ID",
              "displayName": "Ad Set ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Set Name",
              "displayName": "Ad Set Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Set Budget",
              "displayName": "Ad Set Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Start Date",
              "displayName": "Start Date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "End Date",
              "displayName": "End Date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Age_Min",
              "displayName": "Age_Min",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Age_Max",
              "displayName": "Age_Max",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Bid Strategy",
              "displayName": "Bid Strategy",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Conversion Location",
              "displayName": "Conversion Location",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Optimization Goal",
              "displayName": "Optimization Goal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Platform",
              "displayName": "Platform",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Placements",
              "displayName": "Placements",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Billing Event",
              "displayName": "Billing Event",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Ad Set)",
              "displayName": "Status (Ad Set)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "AD ID",
              "displayName": "AD ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Ad Name",
              "displayName": "Ad Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Primary Text",
              "displayName": "Primary Text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Headline",
              "displayName": "Headline",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Description",
              "displayName": "Description",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "URL",
              "displayName": "URL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Call To Action",
              "displayName": "Call To Action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Call Number",
              "displayName": "Call Number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Ad)",
              "displayName": "Status (Ad)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Page_ID",
              "displayName": "Page_ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Action",
              "displayName": "Action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Processed",
              "displayName": "Processed",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Last Error",
              "displayName": "Last Error",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Updated At",
              "displayName": "Updated At",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Row No",
              "displayName": "Row No",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "locationDefine": {
            "values": {
              "headerRow": 2,
              "firstDataRow": 3
            }
          }
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        14144,
        7728
      ],
      "id": "e04bf1bb-637d-4391-bf6e-b4fb05df0fc4",
      "name": "Mark Action NONE (CBO) New Ad Body",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mD66ftl4vER2aF4b",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "\n/**\n * Build ABO Campaign Update Body - v9 PERFECT FIX\n * \n * Meta API EDITABLE fields for Campaign UPDATE:\n * - name\n * - status\n * \n *  ABO: NO budget at campaign level\n */\n\nfunction clean(v) {\n  if (typeof v === 'string') {\n    return v.replace(/\\u00A0/g, ' ').replace(/\\r?\\n/g, ' ').trim()\n      .replace(/^=\"\\s*|\\s*\"$/g, '');\n  }\n  return v == null ? '' : v;\n}\n\nfunction normalizeStatus(s) {\n  const v = clean(s).toUpperCase();\n  return ['ACTIVE', 'PAUSED', 'DELETED'].includes(v) ? v : '';\n}\n\nconst row = item.json || {};\n\n// Only process ABO rows\nconst budgetType = clean(row['Budget'] || row.budget_type || '').toLowerCase();\nif (budgetType !== 'ad set budget') {\n  item.json._skipCampaignUpdate = true;\n  item.json._campaignUpdateBody = {};\n  return item;\n}\n\n// Campaign ID (required)\nconst campaignId = clean(row['Campaign ID'] || row.campaign_id || '');\nif (!campaignId) {\n  item.json._skipCampaignUpdate = true;\n  item.json._campaignUpdateBody = {};\n  return item;\n}\n\n// Build update body - ONLY EDITABLE FIELDS (NO budget for ABO campaigns)\nconst updateBody = {};\n\n// Name\nconst name = clean(row['Campaign Name'] || row.campaign_name || '');\nif (name) updateBody.name = name;\n\n// Status\nconst status = normalizeStatus(row['Status (Campaign)'] || row.status_campaign || '');\nif (status) updateBody.status = status;\n\n//  ABO: NO budget fields - budget is at Ad Set level\n\nitem.json._campaignId = campaignId;\nitem.json._campaignUpdateBody = updateBody;\nitem.json._skipCampaignUpdate = Object.keys(updateBody).length === 0;\n\nreturn item;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        12688,
        8240
      ],
      "id": "88c4cc28-3488-4ddd-aeef-5d0e18243c4c",
      "name": "Build ABO Campaign Update Body"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v23.0/{{ $json.campaign_id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json[\"_campaignUpdateBody\"]}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        12880,
        8240
      ],
      "id": "e0bb553f-43f7-4095-8e8b-254925d5bd6a",
      "name": "Ad Set Budget - Camp. update"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "\n/**\n * Build Final Ad Set UPDATE Body (ABO) - v9 PERFECT FIX\n *\n * Meta API EDITABLE fields for AdSet UPDATE:\n * - name\n * - status\n * - daily_budget (ABO only!)\n * - start_time\n * - end_time\n * \n *  NON-EDITABLE: billing_event, optimization_goal, bid_strategy, targeting\n */\n\nfunction clean(v) {\n  if (typeof v === 'string') {\n    return v.replace(/\\u00A0/g, ' ').replace(/\\r?\\n/g, ' ').trim()\n      .replace(/^=\"\\s*|\\s*\"$/g, '');\n  }\n  return v == null ? '' : v;\n}\n\nfunction convertExcelDateToISO(excelDate) {\n  if (!excelDate || excelDate === '') return '';\n  if (typeof excelDate === 'string' && excelDate.includes('T')) return excelDate;\n  const num = Number(excelDate);\n  if (isNaN(num)) return '';\n  const epochStart = Date.UTC(1899, 11, 30);\n  const millisPerDay = 86400000;\n  return new Date(epochStart + num * millisPerDay).toISOString();\n}\n\nfunction convertToKurus(tryAmount) {\n  if (tryAmount === '' || tryAmount == null) return null;\n  const num = parseFloat(tryAmount);\n  if (isNaN(num) || num < 1) return null;\n  const kurus = Math.round(num * 100);\n  return kurus >= 10000 ? String(kurus) : '10000';\n}\n\nfunction normalizeStatus(s) {\n  const v = clean(s).toUpperCase();\n  return ['ACTIVE', 'PAUSED', 'DELETED'].includes(v) ? v : '';\n}\n\nconst row = item.json || {};\n\n// Check budget type - only process ABO\nconst budgetType = clean(row['Budget'] || row.budget_type || '').toLowerCase();\nif (budgetType !== 'ad set budget') {\n  item.json._skipAdsetUpdate = true;\n  item.json._adsetUpdateBody = {};\n  return item;\n}\n\n// Ad Set ID (required)\nconst adsetId = clean(row['Ad Set ID'] || row.adset_id || '');\nif (!adsetId) {\n  item.json._skipAdsetUpdate = true;\n  item.json._adsetUpdateBody = {};\n  return item;\n}\n\n// Build update body - ONLY EDITABLE FIELDS\nconst updateBody = {};\n\n// Name\nconst name = clean(row['Ad Set Name'] || row.adset_name || '');\nif (name) updateBody.name = name;\n\n// Status\nconst status = normalizeStatus(row['Status (Ad Set)'] || row.status_adset || '');\nif (status) updateBody.status = status;\n\n//  ABO: daily_budget IS editable\nconst dailyBudget = convertToKurus(row['Ad Set Budget'] || row.daily_budget || '');\nif (dailyBudget) updateBody.daily_budget = dailyBudget;\n\n// Dates\nconst startTime = convertExcelDateToISO(row['Start Date'] || row.start_time || '');\nconst endTime = convertExcelDateToISO(row['End Date'] || row.end_time || '');\nif (startTime) updateBody.start_time = startTime;\nif (endTime) updateBody.end_time = endTime;\n\nitem.json._adsetId = adsetId;\nitem.json._adsetUpdateBody = updateBody;\nitem.json._skipAdsetUpdate = Object.keys(updateBody).length === 0;\n\nreturn item;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        13088,
        8240
      ],
      "id": "f1f95395-ed5b-40a3-a649-15881406fe46",
      "name": "Build Final Ad Set UPDATE Body (ABO)"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v23.0/{{ $json.adset_id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json._finalBody}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        13280,
        8240
      ],
      "id": "685272f1-c395-414e-a6ba-548012e74352",
      "name": "Ad Set Budget - Ad Set Update"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "\n// Build Ads UPDATE Bodies - v10 PERFECT FIX\n//  CRITICAL: Sets account_id for HTTP Request URLs\n\nconst cur = item.json || {};\n\n// Get Mapping row\nconst mappingItems = $items('Mapping', 0) || [];\nconst row = (mappingItems[$itemIndex] || {}).json || {};\nconst sheetItems = $items('Meta Ads Automation', 0) || [];\nconst sheetRow = (sheetItems[$itemIndex] || {}).json || {};\n\nfunction cleanCell(v) {\n  if (typeof v !== 'string') return v == null ? '' : String(v);\n  return v.replace(/\\u00A0/g, ' ').replace(/\\r?\\n/g, ' ').trim()\n    .replace(/^=\"\\s*|\\s*\"$/g, '');\n}\n\nfunction pickFirst(...vals) {\n  for (const v of vals) {\n    if (v !== undefined && v !== null && String(v).trim() !== '') return String(v).trim();\n  }\n  return '';\n}\n\nfunction normalizeUrl(u) {\n  if (typeof u !== 'string') return '';\n  let s = cleanCell(u);\n  if (!s) return '';\n  if (/^tel:/i.test(s)) return '';\n  if (/^www\\./i.test(s)) s = 'https://' + s;\n  if (!/^https?:\\/\\//i.test(s)) s = 'https://' + s;\n  try { return new URL(s).toString(); } catch { return s; }\n}\n\nfunction normalizePhone(input) {\n  if (typeof input !== 'string') return '';\n  let p = cleanCell(input);\n  if (p.toLowerCase().startsWith('tel:')) {\n    let n = p.slice(4).replace(/[^0-9+]/g, '').replace(/^\\++/, '+');\n    if (!n.startsWith('+')) n = '+' + n;\n    return 'tel:' + n;\n  }\n  let n = p.replace(/[^0-9+]/g, '').replace(/^\\++/, '+');\n  if (!n.startsWith('+')) n = '+' + n;\n  return 'tel:' + n;\n}\n\nfunction appendUtm(base, params) {\n  const entries = Object.entries(params).filter(([, v]) => v != null && String(v).trim() !== '');\n  try {\n    const url = new URL(base);\n    for (const [k, v] of entries) url.searchParams.set(k, v);\n    return url.toString();\n  } catch {\n    if (!entries.length) return base;\n    const qs = entries.map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&');\n    return base + (base.includes('?') ? '&' : '?') + qs;\n  }\n}\n\n//  CRITICAL: Get account_id for HTTP Request URL\nconst account_id = cleanCell(pickFirst(\n  cur.account_id, cur['Account ID'],\n  row.account_id, row['Account ID'],\n  sheetRow.account_id, sheetRow['Account ID']\n));\n\nconst adId = cleanCell(pickFirst(cur.ad_id, cur['AD ID'], row['AD ID'], row.ad_id, sheetRow['AD ID']));\nconst adsetId = cleanCell(pickFirst(cur.adset_id, cur['Ad Set ID'], row['Ad Set ID'], row.adset_id, sheetRow['Ad Set ID']));\n\nconst adName = cleanCell(pickFirst(cur.ad_name, cur['Ad Name'], row['Ad Name'], row.ad_name, sheetRow['Ad Name']));\nconst statusAd = cleanCell(pickFirst(cur.status_ad, cur['Status (Ad)'], row['Status (Ad)'], row.status_ad, sheetRow['Status (Ad)'])).toUpperCase();\n\nconst pageId = cleanCell(pickFirst(cur.fb_page_id, cur['FB Page_ID'], row['FB Page_ID'], row.fb_page_id, sheetRow['FB Page_ID'])).replace(/[^\\d]/g, '');\nconst igUserId = cleanCell(pickFirst(cur.ig_user_id, cur['IG User_ID'], row['IG User_ID'], row.instagram_user_id, sheetRow['IG User_ID'])).replace(/[^\\d]/g, '');\n\nconst primaryText = cleanCell(pickFirst(cur.primary_text, cur['Primary Text'], row['Primary Text'], sheetRow['Primary Text']));\nconst headline = cleanCell(pickFirst(cur.headline, cur['Headline'], row['Headline'], sheetRow['Headline']));\nconst description = cleanCell(pickFirst(cur.description, cur['Description'], row['Description'], sheetRow['Description']));\nconst urlRaw = cleanCell(pickFirst(cur.url, cur['URL'], row['URL'], row.url, sheetRow['URL']));\nconst ctaType = cleanCell(pickFirst(cur.call_to_action, cur['Call To Action'], row['Call To Action'], sheetRow['Call To Action']) || 'LEARN_MORE').toUpperCase();\nconst callNumber = cleanCell(pickFirst(cur.call_number, cur['Call Number'], row['Call Number'], sheetRow['Call Number']));\n\n// Build URL with UTM\nconst normalizedUrl = normalizeUrl(urlRaw);\nconst adsetName = cleanCell(pickFirst(cur.adset_name, cur['Ad Set Name'], row['Ad Set Name'], sheetRow['Ad Set Name']));\nconst platformRaw = cleanCell(pickFirst(cur.platform, cur['Platform'], row['Platform'], sheetRow['Platform']) || 'meta').toLowerCase();\n\nconst finalUrl = normalizedUrl ? appendUtm(normalizedUrl, {\n  utm_source: 'meta',\n  utm_medium: platformRaw.includes('instagram') && platformRaw.includes('facebook') ? 'both' :\n              platformRaw.includes('instagram') ? 'instagram' : 'facebook',\n  utm_campaign: 'ads',\n  utm_content: adsetName || adName\n}) : '';\n\n// CTA\nlet callToAction;\nif (ctaType === 'CALL_NOW' && callNumber) {\n  callToAction = { type: 'CALL_NOW', value: { link: normalizePhone(callNumber) } };\n} else {\n  callToAction = { type: ctaType, value: { link: finalUrl || normalizedUrl || '' } };\n}\n\n// 1) Ad Update Body (name + status only)\nconst adUpdateBody = {};\nif (adName) adUpdateBody.name = adName;\nif (['ACTIVE', 'PAUSED', 'DELETED'].includes(statusAd)) adUpdateBody.status = statusAd;\n\n// 2) Creative Body\nconst linkData = {\n  link: finalUrl || normalizedUrl || 'https://example.com',\n  message: primaryText,\n  name: headline,\n  description: description,\n  call_to_action: callToAction\n};\n\nconst objectStorySpec = { page_id: pageId, link_data: linkData };\nif (igUserId) objectStorySpec.instagram_actor_id = igUserId;\n\nconst creativeBody = {\n  name: `Creative - ${adName} - ${Date.now()}`,\n  object_story_spec: objectStorySpec\n};\n\n// 3) New Ad Body\nconst newAdBody = {\n  name: adName || `Ad - ${Date.now()}`,\n  adset_id: adsetId,\n  status: statusAd || 'PAUSED'\n};\n\n//  CRITICAL: Set all outputs including account_id\nitem.json.account_id = account_id;\nitem.json._adId = adId;\nitem.json._accountId = account_id;  // Also set _accountId for backwards compatibility\nitem.json._adsetId = adsetId;\nitem.json._adUpdateBody = adUpdateBody;\nitem.json._creativeBody = creativeBody;\nitem.json._newAdBody = newAdBody;\nitem.json._hasNameOrStatus = !!(adName || statusAd);\nitem.json._hasCreativeChanges = !!(primaryText || headline || description || urlRaw);\n\nreturn item;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        13488,
        8240
      ],
      "id": "4e21f261-6598-4c9e-b44d-c33b644bbf79",
      "name": "Build ABO Ads Update"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "25d9f7cf-9267-4685-a186-13c4192f59b4",
              "leftValue": "={{ $json._adUpdateBody && !$json._adUpdateBody._noop }}",
              "rightValue": "=0",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        13744,
        7344
      ],
      "id": "16b80a44-b435-4c10-a7f2-6929d751b697",
      "name": "If CBO ( Ad Name - Status)"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "25d9f7cf-9267-4685-a186-13c4192f59b4",
              "leftValue": "={{ $json._adUpdateBody && !$json._adUpdateBody._noop }}",
              "rightValue": "=0",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        13744,
        8048
      ],
      "id": "10fbdc9d-a09c-4815-b6d1-592f7f4732b3",
      "name": "If ABO ( Ad Name - Status)"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v23.0/{{ $json._adId }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json._adUpdateBody}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        13968,
        8032
      ],
      "id": "82e16efc-6257-4425-af14-3ec3e3ec65a9",
      "name": "Ad Set Budget - Ad Update (Ad ID)"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek",
          "mode": "list",
          "cachedResultName": "Meta Ads Automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 222526350,
          "mode": "list",
          "cachedResultName": "Son",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek/edit#gid=222526350"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Action": "none",
            "Row No": "={{ $('Carry Row & Sheet').item.json['row no'] }}"
          },
          "matchingColumns": [
            "Row No"
          ],
          "schema": [
            {
              "id": "Hotel",
              "displayName": "Hotel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Account ID",
              "displayName": "Account ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Campaign ID",
              "displayName": "Campaign ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Campaign Name",
              "displayName": "Campaign Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Objective",
              "displayName": "Objective",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Buying Type",
              "displayName": "Buying Type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Special Ad Categories",
              "displayName": "Special Ad Categories",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Budget",
              "displayName": "Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Lifetime Budget",
              "displayName": "Lifetime Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Campaign)",
              "displayName": "Status (Campaign)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Set ID",
              "displayName": "Ad Set ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Set Name",
              "displayName": "Ad Set Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Set Budget",
              "displayName": "Ad Set Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Start Date",
              "displayName": "Start Date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "End Date",
              "displayName": "End Date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Age_Min",
              "displayName": "Age_Min",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Age_Max",
              "displayName": "Age_Max",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Bid Strategy",
              "displayName": "Bid Strategy",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Conversion Location",
              "displayName": "Conversion Location",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Optimization Goal",
              "displayName": "Optimization Goal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Platform",
              "displayName": "Platform",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Placements",
              "displayName": "Placements",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Billing Event",
              "displayName": "Billing Event",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Ad Set)",
              "displayName": "Status (Ad Set)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "AD ID",
              "displayName": "AD ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Name",
              "displayName": "Ad Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Primary Text",
              "displayName": "Primary Text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Headline",
              "displayName": "Headline",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Description",
              "displayName": "Description",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "URL",
              "displayName": "URL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Call To Action",
              "displayName": "Call To Action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Call Number",
              "displayName": "Call Number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Ad)",
              "displayName": "Status (Ad)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Page_ID",
              "displayName": "Page_ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Action",
              "displayName": "Action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Processed",
              "displayName": "Processed",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Last Error",
              "displayName": "Last Error",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Updated At",
              "displayName": "Updated At",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Row No",
              "displayName": "Row No",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "locationDefine": {
            "values": {
              "headerRow": 2,
              "firstDataRow": 3
            }
          }
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        14112,
        7328
      ],
      "id": "1d1cd40b-8484-49ed-a2e8-a0064255ae92",
      "name": "Mark Action NONE (CBO)-Name/Status",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mD66ftl4vER2aF4b",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek",
          "mode": "list",
          "cachedResultName": "Meta Ads Automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 222526350,
          "mode": "list",
          "cachedResultName": "Son",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek/edit#gid=222526350"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Action": "none",
            "Row No": "={{ $('Carry Row & Sheet').item.json['row no'] }}"
          },
          "matchingColumns": [
            "Row No"
          ],
          "schema": [
            {
              "id": "Hotel",
              "displayName": "Hotel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Account ID",
              "displayName": "Account ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Campaign ID",
              "displayName": "Campaign ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Campaign Name",
              "displayName": "Campaign Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Objective",
              "displayName": "Objective",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Buying Type",
              "displayName": "Buying Type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Special Ad Categories",
              "displayName": "Special Ad Categories",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Budget",
              "displayName": "Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Lifetime Budget",
              "displayName": "Lifetime Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Campaign)",
              "displayName": "Status (Campaign)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Set ID",
              "displayName": "Ad Set ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Set Name",
              "displayName": "Ad Set Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Set Budget",
              "displayName": "Ad Set Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Start Date",
              "displayName": "Start Date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "End Date",
              "displayName": "End Date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Age_Min",
              "displayName": "Age_Min",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Age_Max",
              "displayName": "Age_Max",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Bid Strategy",
              "displayName": "Bid Strategy",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Conversion Location",
              "displayName": "Conversion Location",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Optimization Goal",
              "displayName": "Optimization Goal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Platform",
              "displayName": "Platform",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Placements",
              "displayName": "Placements",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Billing Event",
              "displayName": "Billing Event",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Ad Set)",
              "displayName": "Status (Ad Set)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "AD ID",
              "displayName": "AD ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Name",
              "displayName": "Ad Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Primary Text",
              "displayName": "Primary Text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Headline",
              "displayName": "Headline",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Description",
              "displayName": "Description",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "URL",
              "displayName": "URL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Call To Action",
              "displayName": "Call To Action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Call Number",
              "displayName": "Call Number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Ad)",
              "displayName": "Status (Ad)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Page_ID",
              "displayName": "Page_ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Action",
              "displayName": "Action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Processed",
              "displayName": "Processed",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Last Error",
              "displayName": "Last Error",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Updated At",
              "displayName": "Updated At",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Row No",
              "displayName": "Row No",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "locationDefine": {
            "values": {
              "headerRow": 2,
              "firstDataRow": 3
            }
          }
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        14144,
        8032
      ],
      "id": "0256afa6-cad6-45a3-85e7-2b72326994f5",
      "name": "Mark Action NONE (ABO)-Name/Status",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mD66ftl4vER2aF4b",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek",
          "mode": "list",
          "cachedResultName": "Meta Ads Automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 222526350,
          "mode": "list",
          "cachedResultName": "Son",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1MQlMgOSWr2eE8lWBUFRkPIwF8ilbiPACxzxkrYAK0ek/edit#gid=222526350"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Action": "none",
            "Row No": "={{ $('Carry Row & Sheet').item.json.row }}",
            "AD ID": "={{ $json.id }}"
          },
          "matchingColumns": [
            "Row No"
          ],
          "schema": [
            {
              "id": "Hotel",
              "displayName": "Hotel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Account ID",
              "displayName": "Account ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Campaign ID",
              "displayName": "Campaign ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Campaign Name",
              "displayName": "Campaign Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Objective",
              "displayName": "Objective",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Buying Type",
              "displayName": "Buying Type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Special Ad Categories",
              "displayName": "Special Ad Categories",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Budget",
              "displayName": "Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Lifetime Budget",
              "displayName": "Lifetime Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Campaign)",
              "displayName": "Status (Campaign)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Set ID",
              "displayName": "Ad Set ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Set Name",
              "displayName": "Ad Set Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Ad Set Budget",
              "displayName": "Ad Set Budget",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Start Date",
              "displayName": "Start Date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "End Date",
              "displayName": "End Date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Age_Min",
              "displayName": "Age_Min",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Age_Max",
              "displayName": "Age_Max",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Bid Strategy",
              "displayName": "Bid Strategy",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Conversion Location",
              "displayName": "Conversion Location",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Optimization Goal",
              "displayName": "Optimization Goal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Platform",
              "displayName": "Platform",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Placements",
              "displayName": "Placements",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Billing Event",
              "displayName": "Billing Event",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Ad Set)",
              "displayName": "Status (Ad Set)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "AD ID",
              "displayName": "AD ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Ad Name",
              "displayName": "Ad Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Primary Text",
              "displayName": "Primary Text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Headline",
              "displayName": "Headline",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Description",
              "displayName": "Description",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "URL",
              "displayName": "URL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Call To Action",
              "displayName": "Call To Action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Call Number",
              "displayName": "Call Number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Status (Ad)",
              "displayName": "Status (Ad)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Page_ID",
              "displayName": "Page_ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Action",
              "displayName": "Action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Processed",
              "displayName": "Processed",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Last Error",
              "displayName": "Last Error",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Updated At",
              "displayName": "Updated At",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Row No",
              "displayName": "Row No",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "locationDefine": {
            "values": {
              "headerRow": 2,
              "firstDataRow": 3
            }
          }
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        14208,
        8416
      ],
      "id": "166da723-03d5-4e7d-a622-4a15ae78d5d2",
      "name": "Mark Action NONE (ABO) New Ad Body",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mD66ftl4vER2aF4b",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v23.0/act_{{ $json.account_id || $('Mapping').item.json.account_id }}/ads\n",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"name\": \"{{$node['Build ABO Ads Update'].json._newAdBody.name}}\",\n  \"status\": \"{{$node['Build ABO Ads Update'].json._newAdBody.status}}\",\n  \"adset_id\": \"{{$node['Build ABO Ads Update'].json._newAdBody.adset_id}}\",\n  \"creative\": {\n    \"creative_id\": \"{{$json.id}}\"\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        13968,
        8416
      ],
      "id": "683e9d77-e65a-4b7e-9e9a-574ae2555fce",
      "name": "Ad Set Budget - Ad Update (New Ad Body)"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v23.0/act_{{ $json.account_id || $('Mapping').item.json.account_id }}/adcreatives",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json._creativeBody}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        13728,
        8416
      ],
      "id": "05b697e2-82c7-431a-ae8a-261cffcbca69",
      "name": "Ad Set Budget - Ad Update (Ad Creatives)"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "\n/**\n * Build Campaign Body (CBO) - v10 PERFECT FIX\n * Output: item.json._campaignBody\n * Also passes through account_id for URL\n */\n\nfunction clean(v) {\n  if (typeof v !== 'string') return v == null ? '' : String(v);\n  return v.replace(/\\u00A0/g, ' ').replace(/\\r?\\n/g, ' ').trim()\n    .replace(/^=\"\\s*/, '').replace(/\"\\s*$/, '').replace(/^=\\s*/, '');\n}\n\nfunction mapObjective(raw) {\n  const v = clean(raw).toUpperCase().replace(/\\s+/g, '');\n  \n  if (v.startsWith('OUTCOME_')) {\n    const valid = ['OUTCOME_AWARENESS', 'OUTCOME_ENGAGEMENT', 'OUTCOME_TRAFFIC',\n      'OUTCOME_LEADS', 'OUTCOME_SALES', 'OUTCOME_APP_PROMOTION'];\n    return valid.includes(v) ? v : 'OUTCOME_TRAFFIC';\n  }\n  \n  const mapping = {\n    'ENGAGEMENT': 'OUTCOME_ENGAGEMENT', 'MESSAGES': 'OUTCOME_ENGAGEMENT',\n    'TRAFFIC': 'OUTCOME_TRAFFIC', 'LINK_CLICKS': 'OUTCOME_TRAFFIC',\n    'LEADS': 'OUTCOME_LEADS', 'LEAD_GENERATION': 'OUTCOME_LEADS',\n    'SALES': 'OUTCOME_SALES', 'CONVERSIONS': 'OUTCOME_SALES',\n    'AWARENESS': 'OUTCOME_AWARENESS', 'BRAND_AWARENESS': 'OUTCOME_AWARENESS',\n    'REACH': 'OUTCOME_AWARENESS', 'VIDEO_VIEWS': 'OUTCOME_AWARENESS',\n    'APP_PROMOTION': 'OUTCOME_APP_PROMOTION', 'APP_INSTALLS': 'OUTCOME_APP_PROMOTION'\n  };\n  \n  return mapping[v] || 'OUTCOME_TRAFFIC';\n}\n\nfunction normalizeStatus(s) {\n  const v = clean(s).toUpperCase();\n  return ['ACTIVE', 'PAUSED', 'DELETED'].includes(v) ? v : 'PAUSED';\n}\n\nfunction convertToKurus(tryAmount) {\n  if (tryAmount === '' || tryAmount == null) return null;\n  const num = parseFloat(tryAmount);\n  if (isNaN(num) || num < 1) return null;\n  const kurus = Math.round(num * 100);\n  return kurus >= 10000 ? String(kurus) : '10000';\n}\n\nfunction parseSpecialCategories(raw) {\n  const v = clean(raw).toUpperCase();\n  if (!v || v === 'NONE' || v === '[]') return [];\n  const valid = ['HOUSING', 'EMPLOYMENT', 'CREDIT', 'ISSUES_ELECTIONS_POLITICS'];\n  return v.split(',').map(s => s.trim()).filter(c => valid.includes(c));\n}\n\nconst row = item.json || {};\n\n//  CRITICAL: Pass through account_id for HTTP Request URL\nconst account_id = clean(row['Account ID'] || row.account_id || '');\nitem.json.account_id = account_id;\n\n// Budget type check - only process CBO\nconst budgetType = clean(row['Budget'] || row.budget_type || '').toLowerCase();\nif (budgetType !== 'campaign budget') {\n  item.json._skipCampaign = true;\n  return item;\n}\n\n// Build campaign body\nconst campaignName = clean(row['Campaign Name'] || row.campaign_name);\nconst objective = mapObjective(row['Objective'] || row.objective);\nconst status = normalizeStatus(row['Status (Campaign)'] || row.status_campaign || row.status);\nconst buyingType = clean(row['Buying Type'] || row.buying_type || 'AUCTION').toUpperCase();\nconst specialCategories = parseSpecialCategories(row['Special Ad Categories'] || row.special_ad_categories);\n\n// CBO: Budget is at Campaign level\nconst dailyBudgetRaw = row['Ad Set Budget'] || row.daily_budget || '';\nconst lifetimeBudgetRaw = row['Lifetime Budget'] || row.lifetime_budget || '';\n\nconst campaignBody = {\n  name: campaignName,\n  objective: objective,\n  status: status,\n  buying_type: buyingType,\n  special_ad_categories: specialCategories\n};\n\n// Add budget\nconst dailyBudgetKurus = convertToKurus(dailyBudgetRaw);\nconst lifetimeBudgetKurus = convertToKurus(lifetimeBudgetRaw);\n\nif (dailyBudgetKurus) {\n  campaignBody.daily_budget = dailyBudgetKurus;\n} else if (lifetimeBudgetKurus) {\n  campaignBody.lifetime_budget = lifetimeBudgetKurus;\n}\n\n// Bid strategy\nconst bidStrategy = clean(row['Bid Strategy'] || row.bid_strategy || '').toUpperCase();\nif (bidStrategy && bidStrategy !== 'NONE') {\n  campaignBody.bid_strategy = bidStrategy;\n}\n\nitem.json._campaignBody = campaignBody;\nitem.json._skipCampaign = false;\n\nreturn item;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        12512,
        6096
      ],
      "id": "c45bcb91-657f-4ec5-9faa-37e9d51c8c19",
      "name": "Build Campaign Body (CBO)"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "\n/**\n * Build Campaign Body (ABO) - v10 PERFECT FIX\n * Output: item.json._campaignBody\n * ABO: NO budget at campaign level\n */\n\nfunction clean(v) {\n  if (typeof v !== 'string') return v == null ? '' : String(v);\n  return v.replace(/\\u00A0/g, ' ').replace(/\\r?\\n/g, ' ').trim()\n    .replace(/^=\"\\s*/, '').replace(/\"\\s*$/, '').replace(/^=\\s*/, '');\n}\n\nfunction mapObjective(raw) {\n  const v = clean(raw).toUpperCase().replace(/\\s+/g, '');\n  \n  if (v.startsWith('OUTCOME_')) {\n    const valid = ['OUTCOME_AWARENESS', 'OUTCOME_ENGAGEMENT', 'OUTCOME_TRAFFIC',\n      'OUTCOME_LEADS', 'OUTCOME_SALES', 'OUTCOME_APP_PROMOTION'];\n    return valid.includes(v) ? v : 'OUTCOME_TRAFFIC';\n  }\n  \n  const mapping = {\n    'ENGAGEMENT': 'OUTCOME_ENGAGEMENT', 'MESSAGES': 'OUTCOME_ENGAGEMENT',\n    'TRAFFIC': 'OUTCOME_TRAFFIC', 'LINK_CLICKS': 'OUTCOME_TRAFFIC',\n    'LEADS': 'OUTCOME_LEADS', 'LEAD_GENERATION': 'OUTCOME_LEADS',\n    'SALES': 'OUTCOME_SALES', 'CONVERSIONS': 'OUTCOME_SALES',\n    'AWARENESS': 'OUTCOME_AWARENESS', 'BRAND_AWARENESS': 'OUTCOME_AWARENESS',\n    'REACH': 'OUTCOME_AWARENESS', 'VIDEO_VIEWS': 'OUTCOME_AWARENESS',\n    'APP_PROMOTION': 'OUTCOME_APP_PROMOTION', 'APP_INSTALLS': 'OUTCOME_APP_PROMOTION'\n  };\n  \n  return mapping[v] || 'OUTCOME_TRAFFIC';\n}\n\nfunction normalizeStatus(s) {\n  const v = clean(s).toUpperCase();\n  return ['ACTIVE', 'PAUSED', 'DELETED'].includes(v) ? v : 'PAUSED';\n}\n\nfunction parseSpecialCategories(raw) {\n  const v = clean(raw).toUpperCase();\n  if (!v || v === 'NONE' || v === '[]') return [];\n  const valid = ['HOUSING', 'EMPLOYMENT', 'CREDIT', 'ISSUES_ELECTIONS_POLITICS'];\n  return v.split(',').map(s => s.trim()).filter(c => valid.includes(c));\n}\n\nconst row = item.json || {};\n\n//  CRITICAL: Pass through account_id for HTTP Request URL\nconst account_id = clean(row['Account ID'] || row.account_id || '');\nitem.json.account_id = account_id;\n\n// Budget type check - only process ABO\nconst budgetType = clean(row['Budget'] || row.budget_type || '').toLowerCase();\nif (budgetType !== 'ad set budget') {\n  item.json._skipCampaign = true;\n  return item;\n}\n\n// Build campaign body - NO BUDGET for ABO\nconst campaignName = clean(row['Campaign Name'] || row.campaign_name);\nconst objective = mapObjective(row['Objective'] || row.objective);\nconst status = normalizeStatus(row['Status (Campaign)'] || row.status_campaign || row.status);\nconst buyingType = clean(row['Buying Type'] || row.buying_type || 'AUCTION').toUpperCase();\nconst specialCategories = parseSpecialCategories(row['Special Ad Categories'] || row.special_ad_categories);\n\nconst campaignBody = {\n  name: campaignName,\n  objective: objective,\n  status: status,\n  buying_type: buyingType,\n  special_ad_categories: specialCategories\n};\n\nitem.json._campaignBody = campaignBody;\nitem.json._skipCampaign = false;\n\nreturn item;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        12512,
        6480
      ],
      "id": "06f4cf8e-6c10-4b52-af74-1292e55a48cc",
      "name": "Build Campaign Body (ABO)"
    },
    {
      "parameters": {
        "jsCode": "\n//  Input Validation - v9 PERFECT FIX\n// Enhanced validation with duplicate prevention and comprehensive checks\n\nconst staticData = ($workflow.getStaticData && $workflow.getStaticData('global')) || ($workflow.staticData ||= {});\nstaticData.errors = staticData.errors || [];\nstaticData.processedKeys = staticData.processedKeys || {};\n\nfunction clean(v) {\n  if (typeof v !== 'string') return v == null ? '' : String(v);\n  return v.replace(/\\u00A0/g, ' ').replace(/\\r?\\n/g, ' ').trim().replace(/^=\"\\s*|\\s*\"$/g, '');\n}\n\nfunction validateRow(row, idx) {\n  const errors = [];\n  const warnings = [];\n  \n  // Required fields\n  const accountId = clean(row['Account ID'] || row.account_id || '');\n  const campaignName = clean(row['Campaign Name'] || row.campaign_name || '');\n  const adsetName = clean(row['Ad Set Name'] || row.adset_name || '');\n  const action = clean(row['Action'] || row.action || '').toLowerCase();\n  \n  if (!accountId) errors.push('Account ID is required');\n  if (!campaignName && action.includes('create')) errors.push('Campaign Name is required for create');\n  if (!adsetName && action.includes('create')) errors.push('Ad Set Name is required for create');\n  \n  // Duplicate check key\n  const key = `${accountId}-${campaignName}-${adsetName}-${action}`;\n  if (staticData.processedKeys[key]) {\n    errors.push('Duplicate row detected - already processed');\n  } else {\n    staticData.processedKeys[key] = Date.now();\n  }\n  \n  // Age validation\n  const ageMin = parseInt(row['Age_Min'] || row.age_min || 18, 10);\n  const ageMax = parseInt(row['Age_Max'] || row.age_max || 65, 10);\n  if (ageMin < 13) warnings.push('Age_Min adjusted to minimum 13');\n  if (ageMax > 65) warnings.push('Age_Max adjusted to maximum 65');\n  if (ageMin > ageMax) errors.push('Age_Min cannot be greater than Age_Max');\n  \n  // Budget validation\n  const budgetType = clean(row['Budget'] || row.budget_type || '').toLowerCase();\n  const dailyBudget = parseFloat(row['Ad Set Budget'] || row.daily_budget || 0);\n  if (budgetType === 'ad set budget' && dailyBudget < 100) {\n    warnings.push('Daily budget adjusted to minimum 100 TRY');\n  }\n  \n  // Conversion Location validation\n  const convLoc = clean(row['Conversion Location'] || row.conversion_location || '').toUpperCase();\n  const billingEvent = clean(row['Billing Event'] || row.billing_event || '');\n  const optGoal = clean(row['Optimization Goal'] || row.optimization_goal || '');\n  \n  if (convLoc.includes('CALL') && billingEvent === 'LINK_CLICKS') {\n    warnings.push('CALLS destination requires IMPRESSIONS billing - will be auto-corrected');\n  }\n  \n  // Page ID validation for certain destinations\n  const pageId = clean(row['FB Page_ID'] || row.fb_page_id || '');\n  if ((convLoc.includes('CALL') || optGoal === 'LEAD_GENERATION') && !pageId) {\n    errors.push('FB Page_ID is required for CALL/LEAD destinations');\n  }\n  \n  return { \n    isValid: errors.length === 0, \n    errors, \n    warnings,\n    key \n  };\n}\n\n// Filter items\nconst results = [];\nfor (let i = 0; i < items.length; i++) {\n  const row = items[i].json;\n  const validation = validateRow(row, i);\n  \n  if (validation.isValid) {\n    items[i].json._validationPassed = true;\n    items[i].json._warnings = validation.warnings;\n    results.push(items[i]);\n  } else {\n    // Store error for reporting\n    staticData.errors.push({\n      row: i + 1,\n      campaignName: row['Campaign Name'],\n      errors: validation.errors\n    });\n  }\n}\n\n// Clean up old keys (older than 1 hour)\nconst oneHourAgo = Date.now() - 3600000;\nObject.keys(staticData.processedKeys).forEach(k => {\n  if (staticData.processedKeys[k] < oneHourAgo) {\n    delete staticData.processedKeys[k];\n  }\n});\n\nreturn results;\n"
      },
      "id": "42605763-6c8e-4d2e-bfeb-1bed4bb88c22",
      "name": "Input Validation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        10592,
        6240
      ],
      "alwaysOutputData": true,
      "continueOnFail": true
    }
  ],
  "pinData": {},
  "connections": {
    "Meta Ads Automation": {
      "main": [
        [
          {
            "node": "Input Validation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mapping": {
      "main": [
        [
          {
            "node": "Carry Row & Sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Budget Level (Camp Budget)": {
      "main": [
        [
          {
            "node": "Build Campaign Body (CBO)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Build Campaign Body (ABO)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Camp. ID": {
      "main": [
        [
          {
            "node": "Write Campaign ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Camp. ID1": {
      "main": [
        [
          {
            "node": "Write Campaign ID1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Date & Time / start_time": {
      "main": [
        [
          {
            "node": "Date & Time / end_time",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Date & Time / end_time": {
      "main": [
        [
          {
            "node": "Mapping",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Camp Budget - Camp. Create": {
      "main": [
        [
          {
            "node": "Camp. ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ad Set Budget - Camp. Create": {
      "main": [
        [
          {
            "node": "Camp. ID1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Write Campaign ID": {
      "main": [
        [
          {
            "node": "Build Final Ad Set Body",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Write Campaign ID1": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          },
          {
            "node": "Build Final Ad Set Body1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Action Router": {
      "main": [
        [
          {
            "node": "Sync to Google Sheets",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If Budget Level (Camp Budget)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If Budget Level (Camp Budget)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Campaign Budget - Ad Set Create": {
      "main": [
        [
          {
            "node": "Write Ad Set ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AD Set Budget - Ad Set Create": {
      "main": [
        [
          {
            "node": "Ad Set Result Normalize",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Budget Level (Camp Budget)1": {
      "main": [
        [
          {
            "node": "Build CBO Campaign Update Body",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Build ABO Campaign Update Body",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Action Router",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ad set name": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Finalize Set",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ad Set Result Normalize": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Finalize Set": {
      "main": [
        [
          {
            "node": "Write Ad Set ID1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Final Ad Set Body": {
      "main": [
        [
          {
            "node": "Campaign Budget - Ad Set Create",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Final Ad Set Body1": {
      "main": [
        [
          {
            "node": "AD Set Budget - Ad Set Create",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Write Ad Set ID": {
      "main": [
        [
          {
            "node": "Campaign Budget - Ad Set Create  Build Final Ad Body (CBO)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Campaign Budget - Ad Set Create  Build Final Ad Body (CBO)": {
      "main": [
        [
          {
            "node": "Campaign Budget - Ad Create1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Campaign Budget - Ad Create1": {
      "main": [
        [
          {
            "node": "Write Ad ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Carry Row & Sheet": {
      "main": [
        [
          {
            "node": "Ad set name",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Write Ad ID": {
      "main": [
        [
          {
            "node": "Mark Action NONE (CBO)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Write Ad Set ID1": {
      "main": [
        [
          {
            "node": "Ad Set Budget - Ad Set Create  Build Final Ad Body (ABO)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ad Set Budget - Ad Set Create  Build Final Ad Body (ABO)": {
      "main": [
        [
          {
            "node": "Ad Set Budget - Ad Create",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ad Set Budget - Ad Create": {
      "main": [
        [
          {
            "node": "Write AD ID1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Write AD ID1": {
      "main": [
        [
          {
            "node": "Mark Action NONE (ABO)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Camp Budget - Camp. update": {
      "main": [
        [
          {
            "node": "Build Final Ad Set UPDATE Body (CBO)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Campaign Budget - Ad Set Update": {
      "main": [
        [
          {
            "node": "Build CBO Ads Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    " Fetch from Meta": {
      "main": [
        [
          {
            "node": "Code in JavaScript - Fetch from Meta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript - Sync": {
      "main": [
        [
          {
            "node": " Fetch from Meta",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sync to Google Sheets": {
      "main": [
        [
          {
            "node": "Code in JavaScript - Sync",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "Code in JavaScript3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript - Fetch from Meta": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Code in JavaScript3": {
      "main": [
        [
          {
            "node": "Sync to Google Sheets - Fetch from Meta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Sync to Google Sheets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build CBO Campaign Update Body": {
      "main": [
        [
          {
            "node": "Camp Budget - Camp. update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Final Ad Set UPDATE Body (CBO)": {
      "main": [
        [
          {
            "node": "Campaign Budget - Ad Set Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build CBO Ads Update": {
      "main": [
        [
          {
            "node": "Campaign Budget - Ad Update (Ad Creatives)",
            "type": "main",
            "index": 0
          },
          {
            "node": "If CBO ( Ad Name - Status)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Campaign Budget - Ad Update (Ad ID)": {
      "main": [
        [
          {
            "node": "Mark Action NONE (CBO)-Name/Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Campaign Budget - Ad Update (Ad Creatives)": {
      "main": [
        [
          {
            "node": "Campaign Budget - Ad Update (New Ad Body)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Campaign Budget - Ad Update (New Ad Body)": {
      "main": [
        [
          {
            "node": "Mark Action NONE (CBO) New Ad Body",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build ABO Campaign Update Body": {
      "main": [
        [
          {
            "node": "Ad Set Budget - Camp. update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ad Set Budget - Camp. update": {
      "main": [
        [
          {
            "node": "Build Final Ad Set UPDATE Body (ABO)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Final Ad Set UPDATE Body (ABO)": {
      "main": [
        [
          {
            "node": "Ad Set Budget - Ad Set Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ad Set Budget - Ad Set Update": {
      "main": [
        [
          {
            "node": "Build ABO Ads Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build ABO Ads Update": {
      "main": [
        [
          {
            "node": "Ad Set Budget - Ad Update (Ad Creatives)",
            "type": "main",
            "index": 0
          },
          {
            "node": "If ABO ( Ad Name - Status)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If CBO ( Ad Name - Status)": {
      "main": [
        [
          {
            "node": "Campaign Budget - Ad Update (Ad ID)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If ABO ( Ad Name - Status)": {
      "main": [
        [
          {
            "node": "Ad Set Budget - Ad Update (Ad ID)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ad Set Budget - Ad Update (Ad ID)": {
      "main": [
        [
          {
            "node": "Mark Action NONE (ABO)-Name/Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ad Set Budget - Ad Update (New Ad Body)": {
      "main": [
        [
          {
            "node": "Mark Action NONE (ABO) New Ad Body",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ad Set Budget - Ad Update (Ad Creatives)": {
      "main": [
        [
          {
            "node": "Ad Set Budget - Ad Update (New Ad Body)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Campaign Body (CBO)": {
      "main": [
        [
          {
            "node": "Camp Budget - Camp. Create",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Campaign Body (ABO)": {
      "main": [
        [
          {
            "node": "Ad Set Budget - Camp. Create",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Input Validation": {
      "main": [
        [
          {
            "node": "Date & Time / start_time",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "258335ef-67ed-40e7-b987-2e1f70556c47",
  "meta": {
    "instanceId": "5e9e4ce887eef006c83848bc72ce00ef92cd3d272c625162ce32af1dcb33c8aa"
  },
  "id": "JM5MUpPGVYxNBdph",
  "tags": []
}